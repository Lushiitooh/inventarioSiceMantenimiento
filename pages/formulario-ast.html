<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Análisis de Seguridad en el Trabajo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navbar placeholder -->
    <div id="navbar-placeholder"></div>

    <!-- Contenido Principal del Formulario -->
    <main class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8 min-h-screen">
        <form id="astForm" class="form-container fade-in">
            
            <!-- Cabecera del Formulario -->
            <div class="form-header">
                <h2>ANÁLISIS DE SEGURIDAD EN EL TRABAJO (AST)</h2>
                <p>FTO-AL10195-01</p>
                <div class="mt-4">
                    <div class="timestamp-badge">
                        Fecha y hora de creación: <span id="fechaHoraActual" class="font-bold"></span>
                    </div>
                </div>
            </div>

            <!-- 1. Información General -->
            <section class="form-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <span class="section-icon">1</span>
                        Información General del Trabajo
                    </h3>
                </div>
                
                <div class="form-grid form-grid-3">
                    <div>
                        <label for="empresa" class="form-label required-field">Empresa</label>
                        <input type="text" id="empresa" name="empresa" class="form-input" value="SICE AGENCIA CHILE S.A" readonly>
                    </div>
                    <div class="md:col-span-2">
                        <label for="obra_area" class="form-label required-field">OBRA/Área</label>
                        <input type="text" id="obra_area" name="obra_area" class="form-input" value="Suministro de Puertas Bidireccionales de Control en 7 Estaciones de la Red de Metro." readonly>
                    </div>
                </div>

                <div class="form-grid form-grid-2" style="margin-top: 1.5rem;">
                    <div class="md:col-span-2">
                        <label for="lugar" class="form-label required-field">Lugar Específico</label>
                        <select id="lugar" name="lugar" class="form-select" required>
                            <option value="">Seleccione una estación...</option>
                            <option value="Estacion Universidad de Chile">Estación Universidad de Chile</option>
                            <option value="Estacion San Pablo">Estación San Pablo</option>
                            <option value="Estacion Departamental">Estación Departamental</option>
                            <option value="Estacion Santa Julia">Estación Santa Julia</option>
                            <option value="Estacion San Ramon">Estación San Ramón</option>
                            <option value="Estacion San Joaquin">Estación San Joaquín</option>
                            <option value="Estacion La Granja">Estación La Granja</option>
                        </select>
                    </div>
                </div>

                <div style="margin-top: 1.5rem;">
                    <label for="trabajo" class="form-label required-field">Trabajo a Realizar</label>
                    <textarea id="trabajo" name="trabajo" class="form-textarea" placeholder="Describa detalladamente el trabajo que se va a realizar..."></textarea>
                </div>
            </section>

            <!-- 2. Documento de Respaldo -->
            <section class="form-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <span class="section-icon">2</span>
                        Documento de Respaldo
                    </h3>
                </div>
                
                <div id="documentos-container">
                    <div class="form-grid form-grid-2" id="documento-inicial">
                        <div>
                            <label for="tipoDocumento" class="form-label">Tipo de Documento</label>
                            <select id="tipoDocumento" name="tipoDocumento" class="form-select">
                                <option value="">Seleccione tipo de documento...</option>
                                <option value="procedimiento">Procedimiento</option>
                                <option value="instructivo">Instructivo</option>
                                <option value="otro">Otro</option>
                                <option value="no_requiere">No requiere</option>
                            </select>
                        </div>
                        <div>
                            <label for="nombreCodigo" class="form-label">Nombre o Código del Documento</label>
                            <input type="text" id="nombreCodigo" name="nombreCodigo" class="form-input" placeholder="Ingrese nombre o código del documento">
                        </div>
                    </div>
                    <div id="documentos-adicionales" style="margin-top: 1rem;">
                        <!-- Documentos adicionales se agregarán aquí -->
                    </div>
                </div>
                <button type="button" id="add-documento-button" class="btn btn-secondary" style="margin-top: 1rem;">
                    + Agregar Otro Documento de Respaldo
                </button>
            </section>

            <!-- 3. Elementos de Apoyo -->
            <section class="form-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <span class="section-icon">3</span>
                        Elementos de Apoyo para el Control de los Riesgos
                    </h3>
                </div>
                
                <div id="epp-container">
                    <!-- EPP predeterminados -->
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input id="casco" name="epp_predeterminado" type="checkbox" value="Casco">
                            <label for="casco">Casco</label>
                        </div>
                        <div class="checkbox-item">
                            <input id="linterna_casco" name="epp_predeterminado" type="checkbox" value="Linterna Adosable al Casco">
                            <label for="linterna_casco">Linterna Adosable al Casco</label>
                        </div>
                        <div class="checkbox-item">
                            <input id="lentes" name="epp_predeterminado" type="checkbox" value="Lentes de seguridad">
                            <label for="lentes">Lentes de seguridad</label>
                        </div>
                        <div class="checkbox-item">
                            <input id="zapatos" name="epp_predeterminado" type="checkbox" value="Zapatos de seguridad">
                            <label for="zapatos">Zapatos de seguridad</label>
                        </div>
                        <div class="checkbox-item">
                            <input id="guantes" name="epp_predeterminado" type="checkbox" value="Guantes">
                            <label for="guantes">Guantes</label>
                        </div>
                        <div class="checkbox-item">
                            <input id="guantes_hyflex" name="epp_predeterminado" type="checkbox" value="Guantes Hyflex">
                            <label for="guantes_hyflex">Guantes Hyflex</label>
                        </div>
                        <div class="checkbox-item">
                            <input id="guantes_cabritilla" name="epp_predeterminado" type="checkbox" value="Guantes Cabritilla">
                            <label for="guantes_cabritilla">Guantes Cabritilla</label>
                        </div>
                        <div class="checkbox-item">
                            <input id="protector_auditivo" name="epp_predeterminado" type="checkbox" value="Protector auditivo">
                            <label for="protector_auditivo">Protector auditivo</label>
                        </div>
                        <div class="checkbox-item">
                            <input id="protector_respiratorio" name="epp_predeterminado" type="checkbox" value="Protector respiratorio">
                            <label for="protector_respiratorio">Protector respiratorio</label>
                        </div>
                        <div class="checkbox-item">
                            <input id="arnes" name="epp_predeterminado" type="checkbox" value="Arnés de seguridad">
                            <label for="arnes">Arnés de seguridad</label>
                        </div>
                        <div class="checkbox-item">
                            <input id="cono" name="epp_predeterminado" type="checkbox" value="Cono">
                            <label for="cono">Cono</label>
                        </div>
                        <div class="checkbox-item">
                            <input id="taladro_inalambrico" name="epp_predeterminado" type="checkbox" value="Taladro Inalámbrico">
                            <label for="taladro_inalambrico">Taladro Inalámbrico</label>
                        </div>
                    </div>
                    
                    <!-- EPP adicionales -->
                    <div id="epp-adicionales" style="margin-top: 1.5rem;">
                        <h4 style="font-weight: 600; margin-bottom: 1rem; color: var(--neutral-700);">Elementos Adicionales</h4>
                    </div>
                </div>
                <button type="button" id="add-epp-button" class="btn btn-success" style="margin-top: 1rem;">
                    + Agregar Elemento Adicional
                </button>
            </section>

            <!-- 4. Secuencia del Trabajo -->
            <section class="form-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <span class="section-icon">4</span>
                        Secuencia de las Etapas del Trabajo
                    </h3>
                </div>
                <div id="etapas-container">
                    <!-- Las etapas se generarán dinámicamente -->
                </div>
                <button type="button" id="add-etapa-button" class="btn btn-secondary" style="margin-top: 1.5rem;">
                    + Agregar Otra Etapa
                </button>
            </section>

            <!-- 5. Personal Participante -->
           <section class="form-section">
    <div class="section-header">
        <h3 class="section-title">
            <span class="section-icon">5</span>
            Personal que Participa en la Actividad
        </h3>
    </div>
    
    <!-- Contenedor de personal con cards en lugar de tabla -->
    <div id="personal-cards-container" class="space-y-4">
        <!-- Las tarjetas de personal se generarán aquí dinámicamente -->
    </div>
    
    <!-- Versión alternativa con tabla mejorada (comentada por defecto) -->
    <div id="personal-table-version" class="hidden">
        <div class="table-container-personal">
            <div class="table-responsive">
                <table class="personal-table">
                    <thead>
                        <tr>
                            <th class="personal-name-col">Nombre Completo</th>
                            <th class="personal-rut-col">RUT</th>
                            <th class="personal-signature-col">Firma</th>
                            <th class="personal-actions-col"></th>
                        </tr>
                    </thead>
                    <tbody id="personal-table-body">
                        <!-- Filas de personal se agregarán aquí -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <button type="button" id="add-personal-button" class="btn btn-primary mt-4">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        Añadir Persona
    </button>
</section>

            <!-- 6. Firmas -->
            <section class="form-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <span class="section-icon">6</span>
                        Firmas de Autorización
                    </h3>
                </div>
                <div class="form-grid form-grid-2">
                    <div style="text-align: center;">
                        <label class="form-label">Supervisor a Cargo</label>
                        <div class="signature-container">
                            <canvas id="signature-supervisor"></canvas>
                            <button type="button" onclick="clearSignature('signature-supervisor')" class="btn btn-danger" style="position: absolute; top: 8px; right: 8px; padding: 0.25rem 0.5rem; font-size: 0.75rem;">Limpiar</button>
                        </div>
                        <p style="font-weight: 600; margin-top: 1rem;">Guillermo Osorio</p>
                        <p style="font-size: 0.875rem; color: var(--neutral-500);">Supervisor</p>
                    </div>

                    <div style="text-align: center;">
                        <label class="form-label">Prevencionista de Riesgos (APR)</label>
                        <div class="signature-container">
                            <canvas id="signature-apr"></canvas>
                            <button type="button" onclick="clearSignature('signature-apr')" class="btn btn-danger" style="position: absolute; top: 8px; right: 8px; padding: 0.25rem 0.5rem; font-size: 0.75rem;">Limpiar</button>
                        </div>
                        <select id="prevencionista" name="prevencionista" class="form-select" style="max-width: 300px; margin: 1rem auto;" required>
                            <option value="">Seleccione prevencionista...</option>
                            <option value="Luis Sepúlveda">Luis Sepúlveda</option>
                            <option value="Valeria Huichipan">Valeria Huichipan</option>
                        </select>
                        <p style="font-size: 0.875rem; color: var(--neutral-500);">Prevención de Riesgos</p>
                    </div>
                </div>
            </section>

            <!-- Botones de Acción -->
            <div class="form-section">
                <div style="display: flex; flex-direction: column; gap: 1rem; padding-top: 2rem; border-top: 1px solid var(--neutral-200);">
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <button type="button" class="btn btn-secondary">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Guardar y Enviar
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </main>
<script src="../assets/js/navbar.js"></script>
<script type="module" src="../assets/js/formulario-ast.js"></script>
<script>
// Función de inicialización específica para AST
document.addEventListener('DOMContentLoaded', function() {
    console.log("📋 Página de formulario AST cargada");
    
    // Función global para remover personal (requerida por formulario-ast.js)
    window.removePersonalCard = function(personalId) {
        const card = document.querySelector(`[data-personal-id="${personalId}"]`);
        if (card) {
            card.classList.add('personal-card-remove');
            setTimeout(() => {
                card.remove();
            }, 300);
        }
    };
    
    // Función global para limpiar firma personal (requerida por formulario-ast.js)
    window.clearPersonalSignature = function(personalId) {
        const canvas = document.getElementById(`firma-personal-${personalId}`);
        const container = document.getElementById(`signature-container-${personalId}`);
        const placeholder = document.getElementById(`placeholder-${personalId}`);
        const clearBtn = document.getElementById(`clear-btn-${personalId}`);
        
        if (canvas && container) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            container.classList.remove('has-signature');
            if (placeholder) placeholder.style.display = 'block';
            if (clearBtn) clearBtn.style.display = 'none';
        }
    };
});
</script>
</body>
</html>
