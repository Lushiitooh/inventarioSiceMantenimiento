<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0284c7"/>
    <title>Gestión de Personal - Control EPP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link rel="manifest" href="/inventarioSiceMantenimiento/assets/manifest/manifest.json">
    
    <style>
        .progress-bar {
            transition: width 0.5s ease;
        }
        .status-vigente { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .status-vencido { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .status-por-vencer { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .status-no-aplica { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
        .status-prohibicion { background: #fde2e8; color: #be123c; border: 1px solid #fda4af; }
        
        .worker-card {
            transition: all 0.3s ease;
            border-left: 4px solid #e5e7eb;
        }
        .worker-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
        }
        .worker-card.high-compliance { border-left-color: #10b981; }
        .worker-card.medium-compliance { border-left-color: #f59e0b; }
        .worker-card.low-compliance { border-left-color: #ef4444; }
        
        .document-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        .document-upload-area:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }
        .document-upload-area.dragover {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .compliance-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .compliance-high { background: #10b981; }
        .compliance-medium { background: #f59e0b; }
        .compliance-low { background: #ef4444; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen">

    <!-- Navbar placeholder -->
    <div id="navbar-placeholder"></div>

    <!-- Contenido Principal -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <header class="mb-8 text-center bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-center mb-4">
                <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-600 to-purple-800 bg-clip-text text-transparent">
                    Gestión de Personal
                </h1>
            </div>
            <div class="space-y-2">
                <p id="authStatus" class="text-sm text-gray-600 dark:text-gray-400">Estado: Inicializando...</p>
                <div id="personalStats" class="hidden mt-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-green-50 dark:bg-green-900/20 p-3 rounded-lg">
                        <div class="text-green-600 dark:text-green-400 text-2xl font-bold" id="highComplianceCount">0</div>
                        <div class="text-sm text-green-600 dark:text-green-400">Alto Cumplimiento (≥80%)</div>
                    </div>
                    <div class="bg-yellow-50 dark:bg-yellow-900/20 p-3 rounded-lg">
                        <div class="text-yellow-600 dark:text-yellow-400 text-2xl font-bold" id="mediumComplianceCount">0</div>
                        <div class="text-sm text-yellow-600 dark:text-yellow-400">Medio Cumplimiento (60-79%)</div>
                    </div>
                    <div class="bg-red-50 dark:bg-red-900/20 p-3 rounded-lg">
                        <div class="text-red-600 dark:text-red-400 text-2xl font-bold" id="lowComplianceCount">0</div>
                        <div class="text-sm text-red-600 dark:text-red-400">Bajo Cumplimiento (<60%)</div>
                    </div>
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg">
                        <div class="text-blue-600 dark:text-blue-400 text-2xl font-bold" id="totalWorkers">0</div>
                        <div class="text-sm text-blue-600 dark:text-blue-400">Total Trabajadores</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Mensajes -->
        <div id="messageContainer" class="hidden p-4 mb-6 text-sm rounded-lg shadow-sm" role="alert"></div>

        <!-- Contenido Principal -->
        <div id="mainContent" class="hidden space-y-8">
            
            <!-- Sección Agregar Trabajador -->
            <section id="addWorkerSection" class="hidden bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                        </div>
                        <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-200">Agregar/Editar Trabajador</h2>
                    </div>
                    <button id="cancelEditBtn" class="hidden px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        Cancelar Edición
                    </button>
                </div>

                <form id="addWorkerForm" class="space-y-6">
                    <input type="hidden" id="editingWorkerId" value="">
                    
                    <!-- Información Personal -->
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">Información Personal</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label for="workerRut" class="block mb-2 text-sm font-medium">RUT *</label>
                                <input type="text" id="workerRut" required class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-purple-500" placeholder="12.345.678-9">
                            </div>
                            <div>
                                <label for="workerNombres" class="block mb-2 text-sm font-medium">Nombres *</label>
                                <input type="text" id="workerNombres" required class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-purple-500" placeholder="Juan Carlos">
                            </div>
                            <div>
                                <label for="workerApellidos" class="block mb-2 text-sm font-medium">Apellidos *</label>
                                <input type="text" id="workerApellidos" required class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-purple-500" placeholder="Pérez González">
                            </div>
                            <div>
                                <label for="workerCargo" class="block mb-2 text-sm font-medium">Cargo *</label>
                                <select id="workerCargo" required class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-purple-500">
                                    <option value="">Seleccione cargo...</option>
                                    <option value="TECNICO">TÉCNICO</option>
                                    <option value="SUPERVISOR">SUPERVISOR</option>
                                    <option value="JEFE">JEFE</option>
                                    <option value="PREVENCIONISTA">PREVENCIONISTA</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Contratos y Documentos Básicos -->
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">Contratos y Documentos</h3>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <div class="flex items-center">
                                <input type="checkbox" id="contrato" class="mr-3 w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500">
                                <label for="contrato" class="text-sm font-medium">CONTRATO</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="anexo" class="mr-3 w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500">
                                <label for="anexo" class="text-sm font-medium">ANEXO</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="riohs" class="mr-3 w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500">
                                <label for="riohs" class="text-sm font-medium">RIOHS</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="reec" class="mr-3 w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500">
                                <label for="reec" class="text-sm font-medium">REEC</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="entregaEpp" class="mr-3 w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500">
                                <label for="entregaEpp" class="text-sm font-medium">ENTREGA EPP</label>
                            </div>
                        </div>
                    </div>

                    <!-- Certificaciones y Capacitaciones -->
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">Certificaciones y Capacitaciones</h3>
                        <div id="certificationsContainer" class="space-y-4">
                            <!-- Se generará dinámicamente -->
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-medium rounded-lg px-6 py-3 transition-all transform hover:scale-105">
                        <span id="submitButtonText">Agregar Trabajador</span>
                    </button>
                </form>
            </section>

            <!-- Búsqueda y Filtros -->
            <section class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
                    <div class="flex items-center">
                        <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-200">Personal Registrado</h2>
                        <button id="toggleAddWorker" class="ml-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Agregar Personal
                        </button>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <input type="text" id="searchWorkerInput" placeholder="Buscar por nombre, RUT o cargo..."
                                class="pl-10 pr-4 py-2.5 w-80 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-purple-500">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                        </div>
                        
                        <select id="complianceFilter" class="px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-purple-500">
                            <option value="">Todos los niveles</option>
                            <option value="high">Alto cumplimiento (≥80%)</option>
                            <option value="medium">Medio cumplimiento (60-79%)</option>
                            <option value="low">Bajo cumplimiento (<60%)</option>
                        </select>
                    </div>
                </div>

                <!-- Lista de Trabajadores -->
                <div id="workersContainer" class="space-y-4">
                    <!-- Se llenará dinámicamente -->
                </div>
            </section>

        </div>

        <!-- Loading -->
        <div id="loadingIndicator" class="flex flex-col items-center justify-center mt-16">
            <div class="relative">
                <div class="w-12 h-12 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin"></div>
            </div>
            <p class="mt-4 text-lg text-gray-600 dark:text-gray-400 font-medium">Cargando gestión de personal...</p>
        </div>
    </div>

    <!-- Modal para Ver/Editar Documentos -->
    <div id="documentsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Gestión de Documentos</h3>
                    <button id="closeDocumentsModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="modalWorkerInfo" class="mt-2 text-sm text-gray-600 dark:text-gray-400"></div>
            </div>
            
            <div class="p-6">
                <div id="documentsContent">
                    <!-- Contenido de documentos -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación -->
    <div id="confirmationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Confirmar Acción</h3>
            <p id="confirmationMessage" class="text-gray-600 dark:text-gray-300 mb-6">¿Estás seguro?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelButton" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">Cancelar</button>
                <button id="confirmButton" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../assets/js/navbar.js"></script>
    <!-- PWA Install Handler -->
<script src="../assets/js/pwa-install.js"></script>

<!-- Service Worker -->
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/inventarioSiceMantenimiento/assets/manifest/sw.js', {
                scope: '/inventarioSiceMantenimiento/'
            })
            .then(registration => {
                console.log('✅ Service Worker registrado:', registration.scope);
            })
            .catch(error => {
                console.error('❌ Error registrando Service Worker:', error);
            });
        });
    }
</script>
    <!-- Firebase Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, updateDoc, deleteDoc, Timestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA0UYwg8kjPibnc7bvMwHvZWT01K1uLr2M",
            authDomain: "inventario-epp.firebaseapp.com",
            projectId: "inventario-epp",
            storageBucket: "inventario-epp.appspot.com",
            messagingSenderId: "255309951395",
            appId: "1:255309951395:web:f57cdb7b13c16a53636a16"
        };

        const ADMIN_UID = "hmaz0EfU1FeSBTqYfneDAhqbuLk2"; // Luis Sepúlveda
        const appIdForPath = 'mi-inventario-epp-github';

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Hacer disponibles globalmente
        window.firebaseReady = true;
        window.auth = auth;
        window.db = db;
        window.ADMIN_UID = ADMIN_UID;
        window.appIdForPath = appIdForPath;
        window.collection = collection;
        window.addDoc = addDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.Timestamp = Timestamp;
        window.orderBy = orderBy;
        window.onAuthStateChanged = onAuthStateChanged;

        // Disparar evento
        window.dispatchEvent(new CustomEvent('firebaseReady'));
    </script>

    <!-- JavaScript Principal -->
    <script type="module">
        // Esperar a que Firebase esté listo
        await new Promise(resolve => {
            if (window.firebaseReady) {
                resolve();
            } else {
                window.addEventListener('firebaseReady', resolve, { once: true });
            }
        });

        console.log("🔥 Firebase listo, iniciando gestión de personal");

        // Variables globales
        let allWorkers = [];
        let isEditMode = false;
        let editingWorkerId = null;
        let confirmCallback = null;

        // Configuración de Cloudinary
        const CLOUDINARY_CLOUD_NAME = "dep5jbtjh";
        const CLOUDINARY_UPLOAD_PRESET = "inv_epp_unsigned";

        // Definición de certificaciones/capacitaciones
        const certifications = [
            { key: 'examen', name: 'Examen ACHS', hasDate: true, hasVencimiento: true },
            { key: 'sstMetro', name: 'SST Metro', hasDate: true, hasVencimiento: true },
            { key: 'opr', name: 'OPR DS44', hasDate: true, hasVencimiento: true },
            { key: 'primeraRespuesta', name: 'Primera Respuesta', hasDate: true, hasVencimiento: true },
            { key: 'respCivil', name: 'Responsabilidad Civil', hasDate: true, hasVencimiento: true },
            { key: 'extintores', name: 'Extintores', hasDate: true, hasVencimiento: true },
            { key: 'alcoholDrogas', name: 'Alcohol y Drogas', hasDate: true, hasVencimiento: true },
            { key: 'personasTrabajadoras', name: 'Formación Personas Trabajadoras', hasDate: true, hasVencimiento: true },
        ];

        // Referencias DOM
        const elements = {
            authStatus: document.getElementById('authStatus'),
            mainContent: document.getElementById('mainContent'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            messageContainer: document.getElementById('messageContainer'),
            addWorkerSection: document.getElementById('addWorkerSection'),
            toggleAddWorker: document.getElementById('toggleAddWorker'),
            addWorkerForm: document.getElementById('addWorkerForm'),
            cancelEditBtn: document.getElementById('cancelEditBtn'),
            workersContainer: document.getElementById('workersContainer'),
            searchWorkerInput: document.getElementById('searchWorkerInput'),
            complianceFilter: document.getElementById('complianceFilter'),
            documentsModal: document.getElementById('documentsModal'),
            closeDocumentsModal: document.getElementById('closeDocumentsModal'),
            confirmationModal: document.getElementById('confirmationModal'),
            confirmButton: document.getElementById('confirmButton'),
            cancelButton: document.getElementById('cancelButton'),
            personalStats: document.getElementById('personalStats')
        };

        // Inicialización
        async function init() {
            console.log("📋 Inicializando gestión de personal");
            
            // Verificar autenticación
            window.onAuthStateChanged(window.auth, (user) => {
                updateUIVisibility(user);
                if (user && user.uid === window.ADMIN_UID) {
                    loadWorkers();
                }
            });

            // Generar formulario de certificaciones
            generateCertificationFields();
            
            // Event listeners
            setupEventListeners();
        }

        function updateUIVisibility(user) {
            const isAuthorized = user && user.uid === window.ADMIN_UID;
            
            if (elements.authStatus) {
                elements.authStatus.textContent = isAuthorized 
                    ? `Acceso autorizado: ${user.email}` 
                    : "Acceso restringido - Solo Luis Sepúlveda";
            }

            if (isAuthorized) {
                elements.mainContent?.classList.remove('hidden');
                elements.personalStats?.classList.remove('hidden');
            } else {
                // Mostrar mensaje de acceso restringido
                elements.mainContent.innerHTML = `
                    <div class="text-center py-16">
                        <div class="w-24 h-24 bg-red-100 dark:bg-red-900 rounded-full flex items-center justify-center mx-auto mb-6">
                            <svg class="w-12 h-12 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Acceso Restringido</h2>
                        <p class="text-gray-600 dark:text-gray-400 mb-6">Esta sección está disponible únicamente para Luis Sepúlveda.</p>
                        <p class="text-sm text-gray-500 dark:text-gray-500">Por favor, inicie sesión con las credenciales autorizadas.</p>
                    </div>
                `;
                elements.mainContent.classList.remove('hidden');
            }
            
            elements.loadingIndicator?.classList.add('hidden');
        }

        function generateCertificationFields() {
            const container = document.getElementById('certificationsContainer');
            if (!container) return;

            container.innerHTML = certifications.map(cert => `
                <div class="certification-group border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-semibold text-gray-700 dark:text-gray-200">${cert.name}</h4>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm">Estado:</label>
                            <select id="${cert.key}Status" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-sm">
                                <option value="">Sin definir</option>
                                <option value="Vigente">Vigente</option>
                                <option value="Vencido">Vencido</option>
                                <option value="Por Vencer">Por Vencer</option>
                                <option value="No Aplica">No Aplica</option>
                                <option value="Prohibición">Prohibición</option>
                            </select>
                        </div>
                    </div>
                    
                    ${cert.hasDate ? `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Fecha de Realización</label>
                                <input type="date" id="${cert.key}Date" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-sm">
                            </div>
                            ${cert.hasVencimiento ? `
                                <div>
                                    <label class="block text-sm font-medium mb-1">Fecha de Vencimiento</label>
                                    <input type="date" id="${cert.key}Expiry" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-sm">
                                </div>
                            ` : ''}
                            <div>
                                <label class="block text-sm font-medium mb-1">Documento</label>
                                <div class="flex items-center space-x-2">
                                    <input type="file" id="${cert.key}File" accept=".pdf,.jpg,.jpeg,.png" class="hidden">
                                    <button type="button" onclick="document.getElementById('${cert.key}File').click()" class="px-3 py-2 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
                                        Subir Archivo
                                    </button>
                                    <span id="${cert.key}FileName" class="text-xs text-gray-500"></span>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function setupEventListeners() {
            // Toggle agregar trabajador
            elements.toggleAddWorker?.addEventListener('click', () => {
                const isHidden = elements.addWorkerSection.classList.contains('hidden');
                elements.addWorkerSection.classList.toggle('hidden', !isHidden);
                if (!isEditMode && !isHidden) {
                    resetForm();
                }
            });

            // Cancelar edición
            elements.cancelEditBtn?.addEventListener('click', () => {
                resetForm();
                elements.addWorkerSection.classList.add('hidden');
            });

            // Formulario
            elements.addWorkerForm?.addEventListener('submit', handleWorkerSubmit);

            // Búsqueda y filtros
            elements.searchWorkerInput?.addEventListener('input', filterWorkers);
            elements.complianceFilter?.addEventListener('change', filterWorkers);

            // Modales
            elements.closeDocumentsModal?.addEventListener('click', () => {
                elements.documentsModal.classList.add('hidden');
            });

            elements.confirmButton?.addEventListener('click', () => {
                if (confirmCallback) confirmCallback();
                hideConfirmationModal();
            });

            elements.cancelButton?.addEventListener('click', hideConfirmationModal);
        }

        async function loadWorkers() {
            try {
                console.log("📋 Cargando trabajadores...");
                const workersRef = window.collection(window.db, `artifacts/${window.appIdForPath}/users/${window.ADMIN_UID}/workers`);
                
                window.onSnapshot(window.query(workersRef, window.orderBy('apellidos', 'asc')), (snapshot) => {
                    allWorkers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    displayWorkers();
                    updateStats();
                    console.log(`📋 Cargados ${allWorkers.length} trabajadores`);
                }, (error) => {
                    console.error("❌ Error cargando trabajadores:", error);
                    showMessage(`Error al cargar trabajadores: ${error.message}`, 'error');
                });
            } catch (error) {
                console.error("❌ Error configurando listener:", error);
                showMessage(`Error de configuración: ${error.message}`, 'error');
            }
        }

        function calculateCompliance(worker) {
            let total = 0;
            let completed = 0;

            // Documentos básicos (5 puntos cada uno)
            const basicDocs = ['contrato', 'anexo', 'riohs', 'reec', 'entregaEpp'];
            basicDocs.forEach(doc => {
                total += 5;
                if (worker[doc]) completed += 5;
            });

            // Certificaciones (10 puntos cada una)
            certifications.forEach(cert => {
                total += 10;
                const status = worker[`${cert.key}Status`];
                if (status === 'Vigente') {
                    completed += 10;
                } else if (status === 'Por Vencer') {
                    completed += 7;
                } else if (status === 'No Aplica') {
                    // No se cuenta para el total
                    total -= 10;
                }
            });

            return total > 0 ? Math.round((completed / total) * 100) : 0;
        }

        function getComplianceLevel(percentage) {
            if (percentage >= 80) return 'high';
            if (percentage >= 60) return 'medium';
            return 'low';
        }

        function displayWorkers() {
            if (!elements.workersContainer) return;

            let filteredWorkers = [...allWorkers];

            // Aplicar filtros
            const searchTerm = elements.searchWorkerInput?.value.toLowerCase().trim();
            const complianceLevel = elements.complianceFilter?.value;

            if (searchTerm) {
                filteredWorkers = filteredWorkers.filter(worker => 
                    `${worker.nombres} ${worker.apellidos}`.toLowerCase().includes(searchTerm) ||
                    worker.rut?.toLowerCase().includes(searchTerm) ||
                    worker.cargo?.toLowerCase().includes(searchTerm)
                );
            }

            if (complianceLevel) {
                filteredWorkers = filteredWorkers.filter(worker => {
                    const compliance = calculateCompliance(worker);
                    return getComplianceLevel(compliance) === complianceLevel;
                });
            }

            if (filteredWorkers.length === 0) {
                elements.workersContainer.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">No hay trabajadores</h3>
                        <p class="text-gray-500 dark:text-gray-400">
                            ${searchTerm || complianceLevel ? 'No se encontraron trabajadores que coincidan con los filtros.' : 'Comience agregando el primer trabajador al sistema.'}
                        </p>
                    </div>
                `;
                return;
            }

            elements.workersContainer.innerHTML = filteredWorkers.map(worker => {
                const compliance = calculateCompliance(worker);
                const complianceLevel = getComplianceLevel(compliance);
                
                return `
                    <div class="worker-card ${complianceLevel}-compliance bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center mb-2">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                                        ${worker.nombres} ${worker.apellidos}
                                    </h3>
                                    <span class="ml-3 px-2 py-1 text-xs font-medium rounded-full bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">
                                        ${worker.cargo}
                                    </span>
                                </div>
                                
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                                    RUT: ${worker.rut}
                                </p>
                                
                                <div class="flex items-center mb-4">
                                    <span class="compliance-indicator compliance-${complianceLevel}"></span>
                                    <span class="text-sm font-medium">Cumplimiento: ${compliance}%</span>
                                    <div class="ml-4 flex-1 bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                        <div class="progress-bar h-2 rounded-full ${complianceLevel === 'high' ? 'bg-green-500' : complianceLevel === 'medium' ? 'bg-yellow-500' : 'bg-red-500'}" 
                                             style="width: ${compliance}%"></div>
                                    </div>
                                </div>
                                
                                <div class="flex flex-wrap gap-2 mb-4">
                                    ${certifications.slice(0, 4).map(cert => {
                                        const status = worker[`${cert.key}Status`];
                                        const statusClass = status ? `status-${status.toLowerCase().replace(' ', '-').replace('ó', 'o')}` : 'status-no-aplica';
                                        return `<span class="px-2 py-1 text-xs rounded ${statusClass}">${cert.name}: ${status || 'N/A'}</span>`;
                                    }).join('')}
                                </div>
                            </div>
                            
                            <div class="flex flex-col space-y-2 ml-4">
                                <button onclick="editWorker('${worker.id}')" class="px-3 py-2 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 transition-colors">
                                    Editar
                                </button>
                                <button onclick="viewDocuments('${worker.id}')" class="px-3 py-2 bg-green-500 text-white rounded text-sm hover:bg-green-600 transition-colors">
                                    Documentos
                                </button>
                                <button onclick="deleteWorker('${worker.id}', '${worker.nombres} ${worker.apellidos}')" class="px-3 py-2 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors">
                                    Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            const highCount = allWorkers.filter(w => getComplianceLevel(calculateCompliance(w)) === 'high').length;
            const mediumCount = allWorkers.filter(w => getComplianceLevel(calculateCompliance(w)) === 'medium').length;
            const lowCount = allWorkers.filter(w => getComplianceLevel(calculateCompliance(w)) === 'low').length;

            document.getElementById('highComplianceCount').textContent = highCount;
            document.getElementById('mediumComplianceCount').textContent = mediumCount;
            document.getElementById('lowComplianceCount').textContent = lowCount;
            document.getElementById('totalWorkers').textContent = allWorkers.length;
        }

        async function handleWorkerSubmit(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = isEditMode ? 'Actualizando...' : 'Guardando...';

            try {
                const workerData = await collectFormData();
                const workersRef = window.collection(window.db, `artifacts/${window.appIdForPath}/users/${window.ADMIN_UID}/workers`);

                if (isEditMode && editingWorkerId) {
                    await window.updateDoc(window.doc(workersRef, editingWorkerId), {
                        ...workerData,
                        updatedAt: window.Timestamp.now()
                    });
                    showMessage('Trabajador actualizado correctamente', 'success');
                } else {
                    await window.addDoc(workersRef, {
                        ...workerData,
                        createdAt: window.Timestamp.now(),
                        updatedAt: window.Timestamp.now()
                    });
                    showMessage('Trabajador agregado correctamente', 'success');
                }

                resetForm();
                elements.addWorkerSection.classList.add('hidden');

            } catch (error) {
                console.error('Error guardando trabajador:', error);
                showMessage(`Error al guardar: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        async function collectFormData() {
            const data = {
                rut: document.getElementById('workerRut').value.trim(),
                nombres: document.getElementById('workerNombres').value.trim(),
                apellidos: document.getElementById('workerApellidos').value.trim(),
                cargo: document.getElementById('workerCargo').value,
                
                // Documentos básicos
                contrato: document.getElementById('contrato').checked,
                anexo: document.getElementById('anexo').checked,
                riohs: document.getElementById('riohs').checked,
                reec: document.getElementById('reec').checked,
                entregaEpp: document.getElementById('entregaEpp').checked,
            };

            // Certificaciones
            for (const cert of certifications) {
                data[`${cert.key}Status`] = document.getElementById(`${cert.key}Status`).value;
                
                if (cert.hasDate) {
                    const dateValue = document.getElementById(`${cert.key}Date`).value;
                    if (dateValue) {
                        data[`${cert.key}Date`] = window.Timestamp.fromDate(new Date(dateValue));
                    }
                    
                    if (cert.hasVencimiento) {
                        const expiryValue = document.getElementById(`${cert.key}Expiry`).value;
                        if (expiryValue) {
                            data[`${cert.key}Expiry`] = window.Timestamp.fromDate(new Date(expiryValue));
                        }
                    }
                }

                // Subir archivo si hay uno
                const fileInput = document.getElementById(`${cert.key}File`);
                if (fileInput && fileInput.files[0]) {
                    try {
                        const uploadedUrl = await uploadFile(fileInput.files[0]);
                        data[`${cert.key}Document`] = uploadedUrl;
                    } catch (error) {
                        console.error(`Error subiendo archivo para ${cert.name}:`, error);
                    }
                }
            }

            return data;
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

            const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/raw/upload`, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(`Error en la subida: ${response.statusText}`);
            }

            const data = await response.json();
            return data.secure_url;
        }

        function resetForm() {
            isEditMode = false;
            editingWorkerId = null;
            elements.addWorkerForm.reset();
            elements.cancelEditBtn.classList.add('hidden');
            document.getElementById('submitButtonText').textContent = 'Agregar Trabajador';
            document.getElementById('editingWorkerId').value = '';
            
            // Limpiar nombres de archivos
            certifications.forEach(cert => {
                const fileNameSpan = document.getElementById(`${cert.key}FileName`);
                if (fileNameSpan) fileNameSpan.textContent = '';
            });
        }

        function filterWorkers() {
            displayWorkers();
        }

        function showMessage(message, type = 'info') {
            const container = elements.messageContainer;
            if (!container) return;
            
            container.textContent = message;
            const classes = {
                success: 'bg-green-100 text-green-700 border-green-200',
                error: 'bg-red-100 text-red-700 border-red-200',
                warning: 'bg-yellow-100 text-yellow-700 border-yellow-200',
                info: 'bg-blue-100 text-blue-700 border-blue-200'
            };
            
            container.className = `p-4 mb-6 text-sm rounded-lg border ${classes[type] || classes.info}`;
            container.classList.remove('hidden');
            
            setTimeout(() => {
                container.classList.add('hidden');
            }, 5000);
        }

        function showConfirmationModal(message, callback) {
            document.getElementById('confirmationMessage').textContent = message;
            confirmCallback = callback;
            elements.confirmationModal.classList.remove('hidden');
        }

        function hideConfirmationModal() {
            elements.confirmationModal.classList.add('hidden');
            confirmCallback = null;
        }

        // Funciones globales para eventos onclick
        window.editWorker = function(workerId) {
            const worker = allWorkers.find(w => w.id === workerId);
            if (!worker) return;

            isEditMode = true;
            editingWorkerId = workerId;

            // Rellenar formulario
            document.getElementById('workerRut').value = worker.rut || '';
            document.getElementById('workerNombres').value = worker.nombres || '';
            document.getElementById('workerApellidos').value = worker.apellidos || '';
            document.getElementById('workerCargo').value = worker.cargo || '';

            // Documentos básicos
            document.getElementById('contrato').checked = worker.contrato || false;
            document.getElementById('anexo').checked = worker.anexo || false;
            document.getElementById('riohs').checked = worker.riohs || false;
            document.getElementById('reec').checked = worker.reec || false;
            document.getElementById('entregaEpp').checked = worker.entregaEpp || false;

            // Certificaciones
            certifications.forEach(cert => {
                const statusSelect = document.getElementById(`${cert.key}Status`);
                if (statusSelect) statusSelect.value = worker[`${cert.key}Status`] || '';

                if (cert.hasDate) {
                    const dateInput = document.getElementById(`${cert.key}Date`);
                    if (dateInput && worker[`${cert.key}Date`]) {
                        const date = worker[`${cert.key}Date`].toDate();
                        dateInput.value = date.toISOString().split('T')[0];
                    }

                    if (cert.hasVencimiento) {
                        const expiryInput = document.getElementById(`${cert.key}Expiry`);
                        if (expiryInput && worker[`${cert.key}Expiry`]) {
                            const date = worker[`${cert.key}Expiry`].toDate();
                            expiryInput.value = date.toISOString().split('T')[0];
                        }
                    }
                }

                // Mostrar nombre de archivo si existe
                if (worker[`${cert.key}Document`]) {
                    const fileNameSpan = document.getElementById(`${cert.key}FileName`);
                    if (fileNameSpan) {
                        fileNameSpan.textContent = 'Archivo cargado';
                        fileNameSpan.className = 'text-xs text-green-600';
                    }
                }
            });

            elements.cancelEditBtn.classList.remove('hidden');
            document.getElementById('submitButtonText').textContent = 'Actualizar Trabajador';
            elements.addWorkerSection.classList.remove('hidden');
            
            // Scroll al formulario
            elements.addWorkerSection.scrollIntoView({ behavior: 'smooth' });
        };

        window.viewDocuments = function(workerId) {
            const worker = allWorkers.find(w => w.id === workerId);
            if (!worker) return;

            document.getElementById('modalWorkerInfo').textContent = 
                `${worker.nombres} ${worker.apellidos} - ${worker.cargo} - RUT: ${worker.rut}`;

            const documentsContent = document.getElementById('documentsContent');
            documentsContent.innerHTML = `
                <div class="space-y-6">
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                        <h4 class="font-semibold mb-3">Resumen de Cumplimiento</h4>
                        <div class="flex items-center mb-2">
                            <span class="w-3 h-3 rounded-full inline-block mr-2 ${calculateCompliance(worker) >= 80 ? 'bg-green-500' : calculateCompliance(worker) >= 60 ? 'bg-yellow-500' : 'bg-red-500'}"></span>
                            <span class="font-medium">${calculateCompliance(worker)}% de cumplimiento</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                            <div class="h-2 rounded-full ${calculateCompliance(worker) >= 80 ? 'bg-green-500' : calculateCompliance(worker) >= 60 ? 'bg-yellow-500' : 'bg-red-500'}" 
                                 style="width: ${calculateCompliance(worker)}%"></div>
                        </div>
                    </div>
                    
                    ${certifications.map(cert => {
                        const status = worker[`${cert.key}Status`] || 'Sin definir';
                        const hasDocument = worker[`${cert.key}Document`];
                        const date = worker[`${cert.key}Date`] ? worker[`${cert.key}Date`].toDate().toLocaleDateString('es-CL') : 'No definida';
                        const expiry = worker[`${cert.key}Expiry`] ? worker[`${cert.key}Expiry`].toDate().toLocaleDateString('es-CL') : 'No definida';
                        
                        return `
                            <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <h5 class="font-medium">${cert.name}</h5>
                                    <span class="px-2 py-1 text-xs rounded status-${status.toLowerCase().replace(' ', '-').replace('ó', 'o')}">${status}</span>
                                </div>
                                ${cert.hasDate ? `
                                    <div class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                                        <p>Fecha: ${date}</p>
                                        ${cert.hasVencimiento ? `<p>Vencimiento: ${expiry}</p>` : ''}
                                    </div>
                                ` : ''}
                                ${hasDocument ? `
                                    <div class="mt-2">
                                        <a href="${worker[`${cert.key}Document`]}" target="_blank" 
                                           class="inline-flex items-center px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                            Ver Documento
                                        </a>
                                    </div>
                                ` : '<p class="text-xs text-gray-500 mt-2">Sin documento adjunto</p>'}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            elements.documentsModal.classList.remove('hidden');
        };

        window.deleteWorker = function(workerId, workerName) {
            showConfirmationModal(
                `¿Estás seguro de que quieres eliminar a ${workerName}? Esta acción no se puede deshacer.`,
                async () => {
                    try {
                        const workersRef = window.collection(window.db, `artifacts/${window.appIdForPath}/users/${window.ADMIN_UID}/workers`);
                        await window.deleteDoc(window.doc(workersRef, workerId));
                        showMessage('Trabajador eliminado correctamente', 'success');
                    } catch (error) {
                        console.error('Error eliminando trabajador:', error);
                        showMessage(`Error al eliminar: ${error.message}`, 'error');
                    }
                }
            );
        };

        // Inicializar la aplicación
        init();
    </script>
</body>
</html>