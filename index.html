<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Inventario EPP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            getDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot,
            query,
            where, // Necesario para buscar préstamos no devueltos
            Timestamp,
            enableIndexedDbPersistence,
            writeBatch // Para operaciones atómicas (descontar stock y crear préstamo)
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ------------------------------------------------------------------------------------
        // IMPORTANTE: CONFIGURACIÓN DE FIREBASE Y ADMINISTRADOR
        // ------------------------------------------------------------------------------------
        // 1. REEMPLAZA ESTO con la configuración de tu proyecto Firebase.
        //    Puedes obtenerla desde la Consola de Firebase > Configuración del Proyecto > Tus apps > SDK setup and configuration > CDN.
        const firebaseConfig = {
  apiKey: "AIzaSyA0UYwg8kjPibnc7bvMwHvZWT01K1uLr2M",
  authDomain: "inventario-epp.firebaseapp.com",
  projectId: "inventario-epp",
  storageBucket: "inventario-epp.firebasestorage.app",
  messagingSenderId: "255309951395",
  appId: "1:255309951395:web:f57cdb7b13c16a53636a16",
  measurementId: "G-T0DKE1NFB3"
};

        // 2. REEMPLAZA ESTO con el UID (User ID) de tu cuenta de administrador.
        //    Puedes obtenerlo desde la Consola de Firebase > Authentication > Pestaña "Users".
        //    NO es tu correo ni tu contraseña.
        const ADMIN_UID = "hmaz0EfU1FeSBTqYfneDAhqbuLk2"; // Ejemplo: "hmaz0EfU1FeSBTqYfneDAhqbuLk2"
        
        // 3. Este es el 'appIdForPath' que usas en la ruta de Firestore.
        //    Debe ser consistente con lo que uses en tus reglas de seguridad de Firestore.
        const appIdForPath = 'mi-inventario-epp-github'; // O el que hayas definido previamente y en tus reglas.
        // ------------------------------------------------------------------------------------

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentLoggedInUser = null;
        let eppInventoryCollectionRef;
        let eppLoansCollectionRef; // Nueva colección para préstamos

        // Elementos del DOM (Login, Logout, Info Usuario)
        const loginSection = document.getElementById('loginSection');
        const loginForm = document.getElementById('loginForm');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const logoutButton = document.getElementById('logoutButton');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const authStatus = document.getElementById('authStatus');
        const loginError = document.getElementById('loginError');
        
        // Elementos del DOM (Formulario EPP)
        const addEppFormSection = document.getElementById('addEppFormSection');
        const addEppForm = document.getElementById('addEppForm');
        const eppNameInput = document.getElementById('eppName');
        const eppSizeInput = document.getElementById('eppSize'); // Nuevo campo Talla
        const eppQuantityInput = document.getElementById('eppQuantity');
        const eppMinStockInput = document.getElementById('eppMinStock');
        
        // Elementos del DOM (Tabla Inventario)
        const eppTableBody = document.getElementById('eppTableBody');
        
        // Elementos del DOM (Sección Préstamos)
        const loansSection = document.getElementById('loansSection');
        const loanEppForm = document.getElementById('loanEppForm');
        const eppToLoanSelect = document.getElementById('eppToLoanSelect');
        const loanQuantityInput = document.getElementById('loanQuantity');
        const loanedToInput = document.getElementById('loanedTo');
        const loansTableBody = document.getElementById('loansTableBody');

        // Elementos del DOM (Generales)
        const loadingIndicator = document.getElementById('loadingIndicator');
        const mainContent = document.getElementById('mainContent');
        const errorMessage = document.getElementById('errorMessage');
        const messageContainer = document.getElementById('messageContainer');
        
        // --- Autenticación y Setup de Firestore ---
        async function setupFirebase() {
            try { await enableIndexedDbPersistence(db); } catch (err) { console.warn("Persistencia offline:", err.message); }

            // Solo definir las referencias a colecciones si ADMIN_UID ha sido configurado
            // y es DIFERENTE del valor placeholder original.
            if (ADMIN_UID && ADMIN_UID !== "PEGAR_AQUI_EL_UID_DEL_ADMINISTRADOR") {
                eppInventoryCollectionRef = collection(db, `artifacts/${appIdForPath}/users/${ADMIN_UID}/epp_inventory`);
                eppLoansCollectionRef = collection(db, `artifacts/${appIdForPath}/users/${ADMIN_UID}/epp_loans`);
            } else {
                // Mostrar error si ADMIN_UID sigue siendo el placeholder o no está definido.
                errorMessage.textContent = "Error Crítico de Configuración: La constante ADMIN_UID no ha sido establecida con tu UID real en el código fuente. Por favor, edita el archivo HTML y reemplaza 'PEGAR_AQUI_EL_UID_DEL_ADMINISTRADOR' con tu User ID de Firebase. La aplicación no funcionará correctamente.";
                errorMessage.classList.remove('hidden');
                loadingIndicator.classList.add('hidden');
                // Detener la ejecución adicional de setup si la configuración es incorrecta.
                return; 
            }


            onAuthStateChanged(auth, (user) => {
                currentLoggedInUser = user;
                adjustAdminColumnsVisibility(user && user.uid === ADMIN_UID); // Ajustar visibilidad de columnas de admin

                if (user) {
                    userIdDisplay.textContent = `Logueado como: ${user.email}`;
                    authStatus.textContent = "Autenticado.";
                    authStatus.classList.remove('text-red-500'); authStatus.classList.add('text-green-500');
                    loginSection.classList.add('hidden');
                    logoutButton.classList.remove('hidden');
                    
                    if (user.uid === ADMIN_UID) {
                        addEppFormSection.classList.remove('hidden');
                        loansSection.classList.remove('hidden'); 
                        loadInventory(true); 
                        loadLoans(); 
                    } else {
                        addEppFormSection.classList.add('hidden');
                        loansSection.classList.add('hidden'); 
                        loadInventory(false);
                        showTemporaryMessage("Cuenta sin permisos de administrador.", "warning");
                    }
                } else {
                    userIdDisplay.textContent = "Visitante";
                    authStatus.textContent = "No autenticado.";
                    authStatus.classList.add('text-red-500'); authStatus.classList.remove('text-green-500');
                    loginSection.classList.remove('hidden');
                    logoutButton.classList.add('hidden');
                    addEppFormSection.classList.add('hidden');
                    loansSection.classList.add('hidden'); 
                    loadInventory(false); 
                }
                mainContent.classList.remove('hidden');
                loadingIndicator.classList.add('hidden');
            });
        }

        // --- Manejo de Login/Logout ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.classList.add('hidden');
            const email = emailInput.value;
            const password = passwordInput.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginForm.reset();
            } catch (error) {
                console.error("Error de inicio de sesión:", error);
                loginError.textContent = `Error: ${mapAuthError(error.code)}`;
                loginError.classList.remove('hidden');
            }
        });

        logoutButton.addEventListener('click', async () => {
            try { await signOut(auth); } catch (error) {
                console.error("Error al cerrar sesión:", error);
                showTemporaryMessage(`Error al cerrar sesión: ${error.message}`, "error");
            }
        });
        
        function mapAuthError(errorCode) {
            switch (errorCode) {
                case 'auth/invalid-email': return 'Formato de correo inválido.';
                case 'auth/user-not-found': case 'auth/wrong-password': case 'auth/invalid-credential': return 'Correo o contraseña incorrectos.';
                default: return 'Error al intentar iniciar sesión.';
            }
        }

        // --- Lógica del Inventario EPP ---
        function loadInventory(isAdminView) {
            if (ADMIN_UID === "PEGAR_AQUI_EL_UID_DEL_ADMINISTRADOR" || !eppInventoryCollectionRef) {
                if (!eppInventoryCollectionRef && ADMIN_UID !== "PEGAR_AQUI_EL_UID_DEL_ADMINISTRADOR") { // Solo mostrar este si ADMIN_UID está bien pero la ref falló por otra razón
                     errorMessage.textContent = "Error: No se pudo conectar a la base de datos del inventario.";
                     errorMessage.classList.remove('hidden');
                }
                // El mensaje de error crítico por ADMIN_UID incorrecto ya se muestra en setupFirebase
                eppTableBody.innerHTML = `<tr><td colspan="${isAdminView ? 7 : 5}" class="text-center py-4 px-6 text-gray-500">Inventario no disponible (configuración pendiente o error de conexión).</td></tr>`;
                loadingIndicator.classList.add('hidden');
                return;
            }

            loadingIndicator.classList.remove('hidden');
            const q = query(eppInventoryCollectionRef); 

            onSnapshot(q, (snapshot) => {
                eppTableBody.innerHTML = ''; 
                if (isAdminView) { // Solo limpiar y poblar dropdown si es admin
                    eppToLoanSelect.innerHTML = '<option value="">Seleccione un EPP</option>'; 
                }
                let items = [];
                snapshot.forEach(doc => {
                    items.push({ id: doc.id, ...doc.data() });
                });

                items.sort((a, b) => (a.name && b.name) ? a.name.localeCompare(b.name) : 0);

                const colCount = isAdminView ? 7 : 5; 
                if (items.length === 0) {
                    eppTableBody.innerHTML = `<tr><td colspan="${colCount}" class="text-center py-4 px-6 text-gray-500">No hay EPP registrados.</td></tr>`;
                } else {
                    items.forEach(item => {
                        renderEppItem(item, isAdminView);
                        if (isAdminView) { 
                            const option = document.createElement('option');
                            option.value = item.id;
                            option.textContent = `${item.name} (Talla: ${item.size || 'N/A'}) - Stock: ${item.quantity}`;
                            option.dataset.stock = item.quantity; 
                            option.dataset.name = item.name;
                            option.dataset.size = item.size || 'N/A';
                            eppToLoanSelect.appendChild(option);
                        }
                    });
                }
                loadingIndicator.classList.add('hidden');
                if(!errorMessage.classList.contains('hidden') && !errorMessage.textContent.startsWith("Error Crítico de Configuración:")) {
                    errorMessage.classList.add('hidden');
                }
            }, (error) => {
                console.error("Error al cargar inventario EPP: ", error);
                errorMessage.textContent = `Error al cargar inventario EPP: ${error.message}.`;
                errorMessage.classList.remove('hidden');
                loadingIndicator.classList.add('hidden');
            });
        }

        function renderEppItem(item, isAdminView) {
            const tr = document.createElement('tr');
            tr.className = `border-b dark:border-gray-700 ${
                item.quantity <= item.minStock ? 'bg-red-100 dark:bg-red-800/50' :
                item.quantity <= item.minStock + (item.minStock * 0.2) ? 'bg-yellow-100 dark:bg-yellow-800/50' :
                'bg-white dark:bg-gray-800'
            }`;

            const stockStatus = item.quantity <= item.minStock 
                ? `<span class="font-semibold text-red-600 dark:text-red-400">BAJO STOCK</span>`
                : (item.quantity <= item.minStock + (item.minStock * 0.2) 
                    ? `<span class="font-semibold text-yellow-600 dark:text-yellow-400">PRÓXIMO A MÍNIMO</span>`
                    : `<span class="font-semibold text-green-600 dark:text-green-400">OK</span>`);

            let adminColumnsHTML = '';
            if (isAdminView) {
                adminColumnsHTML = `
                    <td class="py-3 px-4 sm:px-6 text-center">
                        <button data-id="${item.id}" data-action="decrease" class="px-2 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 text-xs sm:text-sm">-</button>
                        <button data-id="${item.id}" data-action="increase" class="ml-1 px-2 py-1 bg-green-500 text-white rounded-md hover:bg-green-600 text-xs sm:text-sm">+</button>
                    </td>
                    <td class="py-3 px-4 sm:px-6 text-center">
                        <button data-id="${item.id}" data-action="delete" class="px-2 py-1 bg-gray-500 text-white rounded-md hover:bg-gray-600 text-xs sm:text-sm">Eliminar</button>
                    </td>
                `;
            }


            tr.innerHTML = `
                <td class="py-3 px-4 sm:px-6 font-medium text-gray-900 dark:text-white whitespace-nowrap">${item.name}</td>
                <td class="py-3 px-4 sm:px-6 text-center">${item.size || 'N/A'}</td>
                <td class="py-3 px-4 sm:px-6 text-center">${item.quantity}</td>
                <td class="py-3 px-4 sm:px-6 text-center">${item.minStock}</td>
                <td class="py-3 px-4 sm:px-6 text-center">${stockStatus}</td>
                ${adminColumnsHTML} 
            `;
            eppTableBody.appendChild(tr);
        }

        addEppForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentLoggedInUser || currentLoggedInUser.uid !== ADMIN_UID) {
                showTemporaryMessage("Error: Sin permisos.", "error"); return;
            }
            if (!eppInventoryCollectionRef) {
                showTemporaryMessage("Error: Base de datos no lista.", "error"); return;
            }

            const name = eppNameInput.value.trim();
            const size = eppSizeInput.value.trim(); 
            const quantity = parseInt(eppQuantityInput.value);
            const minStock = parseInt(eppMinStockInput.value);

            if (name && !isNaN(quantity) && quantity >= 0 && !isNaN(minStock) && minStock >= 0) {
                try {
                    await addDoc(eppInventoryCollectionRef, { name, size, quantity, minStock, createdAt: Timestamp.now() });
                    addEppForm.reset();
                    showTemporaryMessage("EPP agregado.", "success");
                } catch (error) {
                    console.error("Error al agregar EPP: ", error);
                    showTemporaryMessage(`Error: ${error.message}`, "error");
                }
            } else {
                showTemporaryMessage("Datos inválidos.", "error");
            }
        });

        eppTableBody.addEventListener('click', async (e) => {
            if (e.target.tagName === 'BUTTON') {
                if (!currentLoggedInUser || currentLoggedInUser.uid !== ADMIN_UID) return;

                const action = e.target.dataset.action;
                const id = e.target.dataset.id;
                if (!eppInventoryCollectionRef) { showTemporaryMessage("Error: BD no lista.", "error"); return; }
                const itemRef = doc(eppInventoryCollectionRef, id);

                try {
                    const itemDoc = await getDoc(itemRef);
                    if (!itemDoc.exists()) { showTemporaryMessage("Error: Item no existe.", "error"); return; }
                    const currentQuantity = itemDoc.data().quantity;

                    if (action === 'increase') {
                        await updateDoc(itemRef, { quantity: currentQuantity + 1 });
                    } else if (action === 'decrease') {
                        if (currentQuantity > 0) await updateDoc(itemRef, { quantity: currentQuantity - 1 });
                        else showTemporaryMessage("Cantidad no puede ser < 0.", "warning");
                    } else if (action === 'delete') {
                        showConfirmationModal(`Eliminar "${itemDoc.data().name}"?`, async () => {
                            await deleteDoc(itemRef);
                            showTemporaryMessage("EPP eliminado.", "success");
                        });
                    }
                } catch (error) {
                    console.error(`Error en acción ${action}: `, error);
                    showTemporaryMessage(`Error: ${error.message}`, "error");
                }
            }
        });

        // --- Lógica de Préstamos ---
        loanEppForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentLoggedInUser || currentLoggedInUser.uid !== ADMIN_UID) {
                showTemporaryMessage("Error: Sin permisos.", "error"); return;
            }
            if (!eppLoansCollectionRef || !eppInventoryCollectionRef) {
                showTemporaryMessage("Error: Base de datos no lista.", "error"); return;
            }

            const selectedOption = eppToLoanSelect.options[eppToLoanSelect.selectedIndex];
            const eppId = selectedOption.value;
            const eppName = selectedOption.dataset.name;
            const eppSize = selectedOption.dataset.size;
            const currentStock = parseInt(selectedOption.dataset.stock);
            const quantityToLoan = parseInt(loanQuantityInput.value);
            const loanedTo = loanedToInput.value.trim();

            if (!eppId) { showTemporaryMessage("Seleccione un EPP.", "warning"); return; }
            if (isNaN(quantityToLoan) || quantityToLoan <= 0) { showTemporaryMessage("Cantidad a prestar inválida.", "warning"); return; }
            if (!loanedTo) { showTemporaryMessage("Ingrese a quién se presta.", "warning"); return; }
            if (quantityToLoan > currentStock) { showTemporaryMessage(`Stock insuficiente. Disponible: ${currentStock}`, "error"); return; }

            const batch = writeBatch(db);
            const eppItemRef = doc(eppInventoryCollectionRef, eppId);
            const newLoanRef = doc(collection(eppLoansCollectionRef)); 

            batch.set(newLoanRef, {
                eppId: eppId,
                eppName: eppName,
                eppSize: eppSize,
                quantityLoaned: quantityToLoan,
                loanedTo: loanedTo,
                loanDate: Timestamp.now(),
                returned: false,
                returnedDate: null
            });
            batch.update(eppItemRef, { quantity: currentStock - quantityToLoan });

            try {
                await batch.commit();
                loanEppForm.reset();
                eppToLoanSelect.value = ""; 
                showTemporaryMessage("Préstamo registrado y stock actualizado.", "success");
            } catch (error) {
                console.error("Error al registrar préstamo: ", error);
                showTemporaryMessage(`Error al registrar préstamo: ${error.message}`, "error");
            }
        });

        function loadLoans() {
            if (ADMIN_UID === "PEGAR_AQUI_EL_UID_DEL_ADMINISTRADOR" || !eppLoansCollectionRef) {
                 if (!eppLoansCollectionRef && ADMIN_UID !== "PEGAR_AQUI_EL_UID_DEL_ADMINISTRADOR") { 
                    errorMessage.textContent = "Error de Configuración: No se pudo inicializar la base de datos de préstamos.";
                    errorMessage.classList.remove('hidden');
                 }
                 // El mensaje de error crítico por ADMIN_UID incorrecto ya se muestra en setupFirebase
                 loansTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 px-6 text-gray-500">Préstamos no disponibles (configuración pendiente o error de conexión).</td></tr>`;
                 return;
            }
            
            const q = query(eppLoansCollectionRef, where("returned", "==", false));

            onSnapshot(q, (snapshot) => {
                loansTableBody.innerHTML = '';
                if (snapshot.empty) {
                    loansTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 px-6 text-gray-500">No hay préstamos activos.</td></tr>`;
                    return;
                }
                snapshot.forEach(loanDoc => {
                    renderLoanItem(loanDoc.id, loanDoc.data());
                });
            }, (error) => {
                console.error("Error al cargar préstamos: ", error);
                loansTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 px-6 text-red-500">Error al cargar préstamos.</td></tr>`;
            });
        }

        function renderLoanItem(loanId, loanData) {
            const tr = document.createElement('tr');
            tr.className = 'border-b dark:border-gray-700 bg-white dark:bg-gray-800';
            
            const loanDate = loanData.loanDate instanceof Timestamp ? loanData.loanDate.toDate().toLocaleDateString() : 'Fecha inválida';

            tr.innerHTML = `
                <td class="py-3 px-4 sm:px-6">${loanData.eppName} (Talla: ${loanData.eppSize || 'N/A'})</td>
                <td class="py-3 px-4 sm:px-6 text-center">${loanData.quantityLoaned}</td>
                <td class="py-3 px-4 sm:px-6">${loanData.loanedTo}</td>
                <td class="py-3 px-4 sm:px-6 text-center">${loanDate}</td>
                <td class="py-3 px-4 sm:px-6 text-center font-semibold ${loanData.returned ? 'text-green-500' : 'text-yellow-500'}">
                    ${loanData.returned ? 'Devuelto' : 'Prestado'}
                </td>
                <td class="py-3 px-4 sm:px-6 text-center">
                    ${!loanData.returned ? `<button data-id="${loanId}" data-eppid="${loanData.eppId}" data-qty="${loanData.quantityLoaned}" data-action="returnLoan" class="px-3 py-1.5 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-xs sm:text-sm">Marcar Devuelto</button>` : ''}
                </td>
            `;
            loansTableBody.appendChild(tr);
        }
        
        loansTableBody.addEventListener('click', async (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.action === 'returnLoan') {
                if (!currentLoggedInUser || currentLoggedInUser.uid !== ADMIN_UID) return;

                const loanId = e.target.dataset.id;
                const eppIdToReturn = e.target.dataset.eppid;
                const quantityReturned = parseInt(e.target.dataset.qty);

                if (!eppLoansCollectionRef || !eppInventoryCollectionRef) {
                    showTemporaryMessage("Error: Base de datos no lista.", "error"); return;
                }

                const batch = writeBatch(db);
                const loanRef = doc(eppLoansCollectionRef, loanId);
                const eppItemRef = doc(eppInventoryCollectionRef, eppIdToReturn);

                try {
                    const eppItemDoc = await getDoc(eppItemRef);
                    if (!eppItemDoc.exists()) {
                        showTemporaryMessage("Error: EPP original no encontrado para reponer stock.", "error");
                        return;
                    }
                    const currentEppStock = eppItemDoc.data().quantity;

                    batch.update(loanRef, {
                        returned: true,
                        returnedDate: Timestamp.now()
                    });
                    batch.update(eppItemRef, { quantity: currentEppStock + quantityReturned });
                    
                    await batch.commit();
                    showTemporaryMessage("Préstamo marcado como devuelto y stock actualizado.", "success");
                } catch (error) {
                    console.error("Error al devolver préstamo: ", error);
                    showTemporaryMessage(`Error al devolver préstamo: ${error.message}`, "error");
                }
            }
        });


        // --- Utilidades (Mensajes, Confirmación) ---
        function showTemporaryMessage(message, type = 'info') {
            messageContainer.textContent = message;
            messageContainer.className = `p-3 mb-4 text-sm rounded-lg ${
                type === 'success' ? 'bg-green-100 text-green-700 dark:bg-green-700 dark:text-green-100' :
                type === 'error'   ? 'bg-red-100 text-red-700 dark:bg-red-700 dark:text-red-100'     :
                type === 'warning' ? 'bg-yellow-100 text-yellow-700 dark:bg-yellow-700 dark:text-yellow-100' :
                                     'bg-blue-100 text-blue-700 dark:bg-blue-700 dark:text-blue-100'
            }`;
            messageContainer.classList.remove('hidden');
            setTimeout(() => { messageContainer.classList.add('hidden'); }, 3000);
        }

        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmButton = document.getElementById('confirmButton');
        const cancelButton = document.getElementById('cancelButton');
        let confirmCallback = null;

        function showConfirmationModal(message, callback) {
            confirmationMessage.textContent = message;
            confirmCallback = callback;
            confirmationModal.classList.remove('hidden');
        }
        confirmButton.addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            confirmationModal.classList.add('hidden'); confirmCallback = null;
        });
        cancelButton.addEventListener('click', () => {
            confirmationModal.classList.add('hidden'); confirmCallback = null;
        });

        // --- Ajuste dinámico de visibilidad de columnas de admin ---
        function adjustAdminColumnsVisibility(isAdminView) {
            const adminCols = document.querySelectorAll('.admin-col');
            adminCols.forEach(col => {
                col.style.display = isAdminView ? '' : 'none';
            });
        }
        
        // Inicializar la aplicación
        setupFirebase();
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .table-container { max-height: calc(100vh - 450px); overflow-y: auto; } 
         @media (max-width: 640px) {
            .table-container { max-height: calc(100vh - 520px); }
            th, td { padding-left: 0.5rem; padding-right: 0.5rem; font-size: 0.8rem; }
            button { font-size: 0.8rem; padding: 0.3rem 0.5rem;}
            input, select {font-size: 0.9rem;}
        }
        /* Ocultar columnas de admin por defecto, se mostrarán con JS si es admin */
        .admin-col { display: none; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen flex flex-col items-center p-2 sm:p-4">

    <div class="w-full max-w-5xl"> 
        <header class="mb-6 text-center">
            <h1 class="text-2xl sm:text-3xl font-bold text-blue-600 dark:text-blue-400">Control de Inventario EPP</h1>
            <p id="userIdDisplay" class="text-xs sm:text-sm text-gray-600 dark:text-gray-400 mt-1">Cargando...</p>
            <p id="authStatus" class="text-xs sm:text-sm mt-1">Estado: Inicializando...</p>
            <button id="logoutButton" class="hidden mt-2 px-3 py-1.5 sm:px-4 sm:py-2 bg-red-500 text-white rounded-md hover:bg-red-600 text-xs sm:text-sm">Cerrar Sesión</button>
        </header>

        <section id="loginSection" class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-lg shadow-md mb-8 max-w-md mx-auto">
            <h2 class="text-lg sm:text-xl font-semibold mb-4 text-gray-700 dark:text-gray-200">Iniciar Sesión (Admin)</h2>
            <form id="loginForm">
                <div class="mb-3 sm:mb-4">
                    <label for="email" class="block mb-1 sm:mb-2 text-xs sm:text-sm font-medium">Correo Electrónico:</label>
                    <input type="email" id="email" required class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2 sm:p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="tu@correo.com">
                </div>
                <div class="mb-3 sm:mb-4">
                    <label for="password" class="block mb-1 sm:mb-2 text-xs sm:text-sm font-medium">Contraseña:</label>
                    <input type="password" id="password" required class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2 sm:p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="••••••••">
                </div>
                <div id="loginError" class="hidden p-2 sm:p-3 mb-3 sm:mb-4 text-xs sm:text-sm text-red-700 bg-red-100 rounded-lg dark:bg-red-700 dark:text-red-100" role="alert"></div>
                <button type="submit" class="w-full text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Ingresar</button>
            </form>
        </section>

        <div id="messageContainer" class="hidden p-3 mb-4 text-sm rounded-lg" role="alert"></div>
        <div id="errorMessage" class="hidden p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg dark:bg-red-200 dark:text-red-800" role="alert"></div>

        <div id="mainContent" class="hidden">
            <section id="addEppFormSection" class="hidden bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-lg sm:text-xl font-semibold mb-4 text-gray-700 dark:text-gray-200">Agregar/Modificar EPP</h2>
                <form id="addEppForm">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4">
                        <div>
                            <label for="eppName" class="block mb-1 sm:mb-2 text-xs sm:text-sm font-medium">Nombre EPP:</label>
                            <input type="text" id="eppName" required class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2 sm:p-2.5 dark:bg-gray-700 dark:text-white" placeholder="Casco">
                        </div>
                        <div>
                            <label for="eppSize" class="block mb-1 sm:mb-2 text-xs sm:text-sm font-medium">Talla:</label>
                            <input type="text" id="eppSize" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2 sm:p-2.5 dark:bg-gray-700 dark:text-white" placeholder="M, L, Única">
                        </div>
                        <div>
                            <label for="eppQuantity" class="block mb-1 sm:mb-2 text-xs sm:text-sm font-medium">Cantidad Actual:</label>
                            <input type="number" id="eppQuantity" required min="0" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2 sm:p-2.5 dark:bg-gray-700 dark:text-white" placeholder="50">
                        </div>
                        <div>
                            <label for="eppMinStock" class="block mb-1 sm:mb-2 text-xs sm:text-sm font-medium">Stock Mínimo:</label>
                            <input type="number" id="eppMinStock" required min="0" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2 sm:p-2.5 dark:bg-gray-700 dark:text-white" placeholder="10">
                        </div>
                    </div>
                    <button type="submit" class="mt-4 sm:mt-6 w-full sm:w-auto text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Agregar EPP</button>
                </form>
            </section>

            <section id="loansSection" class="hidden bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-lg sm:text-xl font-semibold mb-4 text-gray-700 dark:text-gray-200">Registrar Préstamo de EPP</h2>
                <form id="loanEppForm">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4">
                        <div>
                            <label for="eppToLoanSelect" class="block mb-1 sm:mb-2 text-xs sm:text-sm font-medium">EPP a Prestar:</label>
                            <select id="eppToLoanSelect" required class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2 sm:p-2.5 dark:bg-gray-700 dark:text-white">
                                <option value="">Seleccione un EPP</option>
                                <!-- Opciones se poblarán por JS -->
                            </select>
                        </div>
                        <div>
                            <label for="loanQuantity" class="block mb-1 sm:mb-2 text-xs sm:text-sm font-medium">Cantidad a Prestar:</label>
                            <input type="number" id="loanQuantity" required min="1" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2 sm:p-2.5 dark:bg-gray-700 dark:text-white" placeholder="1">
                        </div>
                        <div>
                            <label for="loanedTo" class="block mb-1 sm:mb-2 text-xs sm:text-sm font-medium">Prestado A:</label>
                            <input type="text" id="loanedTo" required class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2 sm:p-2.5 dark:bg-gray-700 dark:text-white" placeholder="Nombre Persona/Dpto.">
                        </div>
                    </div>
                    <button type="submit" class="mt-4 sm:mt-6 w-full sm:w-auto text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Registrar Préstamo</button>
                </form>
                
                <h3 class="text-md sm:text-lg font-semibold mt-6 mb-3 text-gray-700 dark:text-gray-200">Préstamos Activos</h3>
                <div class="table-container relative overflow-x-auto shadow-md sm:rounded-lg">
                    <table class="w-full text-xs sm:text-sm text-left text-gray-500 dark:text-gray-400">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400 sticky top-0">
                            <tr>
                                <th scope="col" class="py-2 px-3 sm:py-3 sm:px-6">EPP (Talla)</th>
                                <th scope="col" class="py-2 px-3 sm:py-3 sm:px-6 text-center">Cant.</th>
                                <th scope="col" class="py-2 px-3 sm:py-3 sm:px-6">Prestado A</th>
                                <th scope="col" class="py-2 px-3 sm:py-3 sm:px-6 text-center">Fecha Préstamo</th>
                                <th scope="col" class="py-2 px-3 sm:py-3 sm:px-6 text-center">Estado</th>
                                <th scope="col" class="py-2 px-3 sm:py-3 sm:px-6 text-center">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="loansTableBody">
                            <!-- Filas de préstamos se insertarán aquí -->
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="bg-white dark:bg-gray-800 p-2 sm:p-6 rounded-lg shadow-md">
                <h2 class="text-lg sm:text-xl font-semibold mb-4 text-gray-700 dark:text-gray-200">Inventario Actual General</h2>
                <div class="table-container relative overflow-x-auto shadow-md sm:rounded-lg">
                    <table class="w-full text-xs sm:text-sm text-left text-gray-500 dark:text-gray-400">
                        <thead id="eppInventoryTableHead" class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400 sticky top-0">
                            <tr>
                                <th scope="col" class="py-2 px-3 sm:py-3 sm:px-6">Nombre</th>
                                <th scope="col" class="py-2 px-3 sm:py-3 sm:px-6 text-center">Talla</th>
                                <th scope="col" class="py-2 px-3 sm:py-3 sm:px-6 text-center">Cantidad Disp.</th>
                                <th scope="col" class="py-2 px-3 sm:py-3 sm:px-6 text-center">Stock Mínimo</th>
                                <th scope="col" class="py-2 px-3 sm:py-3 sm:px-6 text-center">Estado</th>
                                <!-- Columnas de admin se manejan con la clase .admin-col y JS -->
                                <th scope="col" class="admin-col py-2 px-3 sm:py-3 sm:px-6 text-center">Ajustar Cant.</th>
                                <th scope="col" class="admin-col py-2 px-3 sm:py-3 sm:px-6 text-center">Eliminar</th>
                            </tr>
                        </thead>
                        <tbody id="eppTableBody"></tbody>
                    </table>
                </div>
            </section>
        </div>

        <div id="loadingIndicator" class="flex justify-center items-center mt-10">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 sm:h-10 sm:w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-base sm:text-lg">Cargando datos...</span>
        </div>
    </div>

    <div id="confirmationModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 p-5 sm:p-6 rounded-lg shadow-xl max-w-xs sm:max-w-sm w-full">
            <h3 class="text-base sm:text-lg font-medium leading-6 text-gray-900 dark:text-white mb-2">Confirmar Acción</h3>
            <p id="confirmationMessage" class="text-xs sm:text-sm text-gray-600 dark:text-gray-300 mb-4">¿Estás seguro?</p>
            <div class="flex justify-end space-x-2 sm:space-x-3">
                <button id="cancelButton" class="px-3 py-1.5 sm:px-4 sm:py-2 text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">Cancelar</button>
                <button id="confirmButton" class="px-3 py-1.5 sm:px-4 sm:py-2 text-xs sm:text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>

</body>
</html>
