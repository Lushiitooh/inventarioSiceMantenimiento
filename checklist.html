<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0284c7"/>
    <title>Checklist - Control EPP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .signature-pad-container {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            position: relative;
            height: 120px;
            background-color: #f9fafb;
        }
        .signature-pad-container canvas {
            width: 100%;
            height: 100%;
            border-radius: 0.375rem;
        }
        .signature-pad-container button {
            position: absolute;
            top: 5px;
            right: 5px;
            z-index: 10;
        }
        @media (max-width: 640px) {
            .signature-pad-container {
                height: 100px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen">

    <!-- Navbar Principal -->
    <nav class="bg-white dark:bg-gray-800 shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <!-- Logo y t√≠tulo -->
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center mr-3">
                            <span class="text-white font-bold text-sm">EPP</span>
                        </div>
                        <h1 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white">
                            Control EPP
                        </h1>
                    </div>
                </div>

                <!-- Navegaci√≥n Desktop -->
                <div class="hidden md:flex space-x-8 items-center">
                    <a href="./index.html" 
                       class="nav-link px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200
                              text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 
                              hover:bg-gray-100 dark:hover:bg-gray-700"
                       data-page="inventario">
                        üì¶ Inventario
                    </a>
                    <a href="./certificados.html" 
                       class="nav-link px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200
                              text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 
                              hover:bg-gray-100 dark:hover:bg-gray-700"
                       data-page="certificados">
                        üìã Certificados
                    </a>
                    <a href="./checklist.html" 
                       class="nav-link px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200
                              text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20"
                       data-page="checklist">
                        ‚úÖ Checklist
                    </a>
                </div>

                <!-- Bot√≥n men√∫ m√≥vil -->
                <div class="md:hidden flex items-center">
                    <button id="mobile-menu-button" 
                            class="inline-flex items-center justify-center p-2 rounded-md 
                                   text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 
                                   hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 
                                   focus:ring-inset focus:ring-blue-500">
                        <span class="sr-only">Abrir men√∫ principal</span>
                        <svg class="h-6 w-6" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Men√∫ m√≥vil -->
        <div id="mobile-menu" class="md:hidden fixed inset-y-0 left-0 w-64 bg-white dark:bg-gray-800 shadow-xl transform -translate-x-full transition-transform duration-300 ease-in-out z-40">
            <div class="flex flex-col h-full">
                <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center mr-3">
                            <span class="text-white font-bold text-sm">EPP</span>
                        </div>
                        <span class="text-lg font-bold text-gray-900 dark:text-white">Control EPP</span>
                    </div>
                    <button id="close-mobile-menu" 
                            class="p-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                        <svg class="h-6 w-6" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div class="flex-1 px-4 py-6 space-y-1">
                    <a href="./index.html" 
                       class="mobile-nav-link flex items-center px-4 py-3 rounded-lg text-base font-medium transition-colors duration-200
                              text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600 dark:hover:text-blue-400"
                       data-page="inventario">
                        <span class="mr-3 text-xl">üì¶</span>
                        Inventario
                    </a>
                    <a href="./certificados.html" 
                       class="mobile-nav-link flex items-center px-4 py-3 rounded-lg text-base font-medium transition-colors duration-200
                              text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600 dark:hover:text-blue-400"
                       data-page="certificados">
                        <span class="mr-3 text-xl">üìã</span>
                        Certificados
                    </a>
                    <a href="./checklist.html" 
                       class="mobile-nav-link flex items-center px-4 py-3 rounded-lg text-base font-medium transition-colors duration-200
                              bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400"
                       data-page="checklist">
                        <span class="mr-3 text-xl">‚úÖ</span>
                        Checklist
                    </a>
                </div>

                <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                    <div class="text-sm text-gray-500 dark:text-gray-400">
                        Sistema de Control EPP v1.0
                    </div>
                </div>
            </div>
        </div>

        <!-- Overlay para cerrar men√∫ m√≥vil -->
        <div id="mobile-menu-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 md:hidden"></div>
    </nav>

    <!-- Contenido Principal -->
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 sm:p-6 lg:p-8">
            
            <!-- Header del formulario -->
            <div class="text-center mb-6 border-b border-gray-200 dark:border-gray-700 pb-4">
                <h1 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white">INSPECCI√ìN DE HERRAMIENTAS MANUALES</h1>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">FTO-AL10195-24 / Versi√≥n 03</p>
            </div>

            <form id="checklistForm" class="space-y-6">
                <!-- SECCI√ìN DE DATOS GENERALES -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Contrato:</label>
                        <p class="text-sm text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                            "Suministro de Puertas Bidireccionales de Control en 7 Estaciones de la Red de Metro"
                        </p>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="sitio" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Sitio/Lugar/Agencia:</label>
                            <select id="sitio" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Seleccione un sitio...</option>
                                <option value="Santa Julia Linea 4A">Santa Julia Linea 4A</option>
                                <option value="San Ramon Linea 4A">San Ramon Linea 4A</option>
                                <option value="La Granja Linea 4A">La Granja Linea 4A</option>
                                <option value="Departamental Linea 2">Departamental Linea 2</option>
                                <option value="Universidad de Chile Linea 1">Universidad de Chile Linea 1</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="fechaInspeccion" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Fecha de Inspecci√≥n:</label>
                            <input type="date" id="fechaInspeccion" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500" readonly>
                        </div>
                    </div>
                    
                    <div>
                        <label for="trabajador" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nombre del Trabajador:</label>
                        <select id="trabajador" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Seleccione un trabajador...</option>
                            <option value="Nestor Flores">Nestor Flores</option>
                            <option value="Ronald Cancino">Ronald Cancino</option>
                            <option value="Nicolas Jara">Nicolas Jara</option>
                            <option value="Juan Carlos Valenzuela">Juan Carlos Valenzuela</option>
                            <option value="Avelino Troncoso">Avelino Troncoso</option>
                            <option value="Ronald Rodriguez">Ronald Rodriguez</option>
                        </select>
                    </div>
                </div>

                <!-- SECCI√ìN DE HERRAMIENTAS MANUALES -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 bg-gray-100 dark:bg-gray-700 p-3 rounded-lg">1. Herramientas Manuales</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="p-3 text-left text-gray-700 dark:text-gray-300 border-b border-gray-300 dark:border-gray-600">√çtem</th>
                                    <th class="p-3 text-left text-gray-700 dark:text-gray-300 border-b border-gray-300 dark:border-gray-600">Herramienta</th>
                                    <th class="p-3 text-center text-gray-700 dark:text-gray-300 border-b border-gray-300 dark:border-gray-600">Estado (B/M/N/A)</th>
                                    <th class="p-3 text-center text-gray-700 dark:text-gray-300 border-b border-gray-300 dark:border-gray-600">Color del Mes (S√≠/No)</th>
                                    <th class="p-3 text-left text-gray-700 dark:text-gray-300 border-b border-gray-300 dark:border-gray-600">Observaciones</th>
                                </tr>
                            </thead>
                            <tbody id="herramientasTableBody" class="bg-white dark:bg-gray-800">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- SECCI√ìN OTRAS HERRAMIENTAS -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 bg-gray-100 dark:bg-gray-700 p-3 rounded-lg">2. Otras Herramientas</h3>
                    <div id="otras-herramientas-container" class="space-y-3"></div>
                    <button type="button" id="add-tool-btn" class="mt-4 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm">Agregar Otra Herramienta</button>
                </div>

                <!-- SECCI√ìN PLAN DE ACCI√ìN -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 bg-gray-100 dark:bg-gray-700 p-3 rounded-lg">3. Plan de Acci√≥n (No obligatorio)</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label for="planAccion" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Plan de Acci√≥n:</label>
                            <input type="text" id="planAccion" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="fechaPlan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Fecha:</label>
                            <input type="date" id="fechaPlan" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="responsablePlan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Responsable:</label>
                            <input type="text" id="responsablePlan" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN DE FIRMAS -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
                    <div class="text-center space-y-3">
                        <div class="bg-gray-100 dark:bg-gray-700 p-2 rounded-lg">
                            <h4 class="font-semibold text-gray-900 dark:text-white">Realiz√≥</h4>
                        </div>
                        <div class="signature-pad-container">
                            <canvas id="firmaRealizoPad"></canvas>
                            <button type="button" class="clear-btn px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600" data-target="firmaRealizoPad">Limpiar</button>
                        </div>
                        <p id="nombreRealizo" class="font-semibold text-gray-900 dark:text-white">Nombre del Trabajador</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">T√©cnico Montajista</p>
                        <input type="date" id="fechaRealizo" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white" readonly>
                    </div>

                    <div class="text-center space-y-3">
                        <div class="bg-gray-100 dark:bg-gray-700 p-2 rounded-lg">
                            <h4 class="font-semibold text-gray-900 dark:text-white">Revis√≥</h4>
                        </div>
                        <div class="signature-pad-container">
                            <canvas id="firmaRevisoPad"></canvas>
                            <button type="button" class="clear-btn px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600" data-target="firmaRevisoPad">Limpiar</button>
                        </div>
                        <p class="font-semibold text-gray-900 dark:text-white">Guillermo Osorio</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Supervisor</p>
                        <input type="date" id="fechaReviso" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white" readonly>
                    </div>

                    <div class="text-center space-y-3">
                        <div class="bg-gray-100 dark:bg-gray-700 p-2 rounded-lg">
                            <h4 class="font-semibold text-gray-900 dark:text-white">V¬∞B¬∞ Prevenci√≥n de Riesgos</h4>
                        </div>
                        <div class="signature-pad-container">
                            <canvas id="firmaPrevencionPad"></canvas>
                            <button type="button" class="clear-btn px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600" data-target="firmaPrevencionPad">Limpiar</button>
                        </div>
                        <select id="prevencionista" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white" required>
                            <option value="">Seleccione...</option>
                            <option value="Valeria Huichipan">Valeria Huichipan</option>
                            <option value="Luis Sep√∫lveda">Luis Sep√∫lveda</option>
                        </select>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Prevenci√≥n de Riesgos</p>
                        <input type="date" id="fechaPrevencion" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white" readonly>
                    </div>
                </div>

                <div class="pt-6">
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg text-lg transition-colors duration-200">
                        Guardar y Enviar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script type="module">
        // Importamos desde tu archivo de configuraci√≥n
        import { db } from './firebase-config.js'; 
        import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', function () {
            // JavaScript para el men√∫ m√≥vil
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const closeMobileMenu = document.getElementById('close-mobile-menu');
            const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');

            function openMobileMenu() {
                mobileMenu.style.transform = 'translateX(0)';
                mobileMenuOverlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            function closeMobileMenuHandler() {
                mobileMenu.style.transform = 'translateX(-100%)';
                mobileMenuOverlay.classList.add('hidden');
                document.body.style.overflow = '';
            }

            mobileMenuButton.addEventListener('click', openMobileMenu);
            closeMobileMenu.addEventListener('click', closeMobileMenuHandler);
            mobileMenuOverlay.addEventListener('click', closeMobileMenuHandler);

            document.querySelectorAll('.mobile-nav-link').forEach(link => {
                link.addEventListener('click', closeMobileMenuHandler);
            });

            // L√≥gica del formulario
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fechaInspeccion').value = today;
            document.getElementById('fechaRealizo').value = today;
            document.getElementById('fechaReviso').value = today;
            document.getElementById('fechaPrevencion').value = today;

            const trabajadorSelect = document.getElementById('trabajador');
            const nombreRealizo = document.getElementById('nombreRealizo');
            trabajadorSelect.addEventListener('change', function() {
                nombreRealizo.textContent = this.value || 'Nombre del Trabajador';
            });

            const herramientas = [
                "Caja Herramientas negra", "Juego de Dados 36 piezas", "Alicate Universal", 
                "Alicate Punta", "Alicate Cortante", "Caiman", "Flexometro", "Juego de dados", 
                "Atornillador de Paleta aislado 1,2x6,5x150mm", "Atornillador de Paleta aislado 1,0x5,5x125mm", 
                "Atornillador de Paleta aislado 0,8x4,0x100mm", "Atornillador de Paleta aislado 0,4x2,5x75mm", 
                "Atornillador de cruz aislado PH2x100mm", "Atornillador de cruz aislado PH1x80mm", 
                "Atornillador de cruz aislado PH0x75mm", "Crimpiadora", "Ventosa para pisos tecnicos", "Martillo"
            ];

            const tbody = document.getElementById('herramientasTableBody');
            herramientas.forEach((herramienta, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-200 dark:border-gray-700';
                tr.innerHTML = `
                    <td class="p-3 text-gray-900 dark:text-white">1.${index + 1}</td>
                    <td class="p-3 text-gray-900 dark:text-white">${herramienta}</td>
                    <td class="p-3 text-center">
                        <div class="flex justify-center space-x-4 text-sm">
                            <label class="flex items-center"><input type="radio" name="estado_${index}" value="Bueno" required class="mr-1"> B</label>
                            <label class="flex items-center"><input type="radio" name="estado_${index}" value="Malo" class="mr-1"> M</label>
                            <label class="flex items-center"><input type="radio" name="estado_${index}" value="N/A" class="mr-1"> N/A</label>
                        </div>
                    </td>
                    <td class="p-3 text-center">
                        <div class="flex justify-center space-x-4 text-sm">
                            <label class="flex items-center"><input type="radio" name="color_${index}" value="Si" required class="mr-1"> S√≠</label>
                            <label class="flex items-center"><input type="radio" name="color_${index}" value="No" class="mr-1"> No</label>
                        </div>
                    </td>
                    <td class="p-3"><input type="text" name="obs_${index}" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm"></td>
                `;
                tbody.appendChild(tr);
            });

            // Configuraci√≥n de firmas
            function setupSignaturePad(canvasId) {
                const canvas = document.getElementById(canvasId);
                const signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });
                
                function resizeCanvas() {
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    canvas.width = canvas.offsetWidth * ratio;
                    canvas.height = canvas.offsetHeight * ratio;
                    canvas.getContext("2d").scale(ratio, ratio);
                    signaturePad.clear();
                }
                
                window.addEventListener("resize", resizeCanvas);
                resizeCanvas();
                return signaturePad;
            }

            const firmaRealizo = setupSignaturePad('firmaRealizoPad');
            const firmaReviso = setupSignaturePad('firmaRevisoPad');
            const firmaPrevencion = setupSignaturePad('firmaPrevencionPad');

            document.querySelectorAll('.clear-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const targetId = e.currentTarget.getAttribute('data-target');
                    if (targetId === 'firmaRealizoPad') firmaRealizo.clear();
                    if (targetId === 'firmaRevisoPad') firmaReviso.clear();
                    if (targetId === 'firmaPrevencionPad') firmaPrevencion.clear();
                });
            });
            
            // Env√≠o del formulario
            document.getElementById('checklistForm').addEventListener('submit', async function(event) {
                event.preventDefault();
                const submitButton = event.currentTarget.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = 'Enviando...';

                const formData = {
                    contrato: "Suministro de Puertas Bidireccionales de Control en 7 Estaciones de la Red de Metro",
                    sitio: document.getElementById('sitio').value,
                    fechaInspeccion: document.getElementById('fechaInspeccion').value,
                    trabajador: document.getElementById('trabajador').value,
                    prevencionista: document.getElementById('prevencionista').value,
                    herramientas: [],
                    firmaRealizoImg: firmaRealizo.isEmpty() ? "" : firmaRealizo.toDataURL(),
                    firmaRevisoImg: firmaReviso.isEmpty() ? "" : firmaReviso.toDataURL(),
                    firmaPrevencionImg: firmaPrevencion.isEmpty() ? "" : firmaPrevencion.toDataURL()
                };

                const herramientasRows = document.querySelectorAll('#herramientasTableBody tr');
                herramientasRows.forEach((row, index) => {
                    formData.herramientas.push({
                        nombre: row.cells[1].textContent,
                        estado: row.querySelector(`input[name="estado_${index}"]:checked`)?.value || 'N/A',
                        color: row.querySelector(`input[name="color_${index}"]:checked`)?.value || 'No',
                        obs: row.querySelector(`input[name="obs_${index}"]`).value
                    });
                });

                try {
                    await addDoc(collection(db, "checklists"), {...formData, createdAt: serverTimestamp()});
                    console.log("Respaldo guardado en Firestore.");
                } catch (error) {
                    console.error("Error al guardar respaldo en Firestore:", error);
                }

                const pipedreamUrl = "https://eopkzao9ptejwdl.m.pipedream.net";

                try {
                    const response = await fetch(pipedreamUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        alert('¬°Checklist enviado con √©xito!');
                    } else {
                        throw new Error('El servidor de Pipedream respondi√≥ con un error.');
                    }
                } catch (error) {
                    console.error("Error al enviar a Pipedream:", error);
                    alert("Hubo un error al enviar el checklist.");
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Guardar y Enviar';
                }
            });
        });
    </script>
</body>
</html>
