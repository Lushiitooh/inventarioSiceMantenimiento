<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <meta name="theme-color" content="#0284c7"/>
    <title>Checklist - Control EPP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="styles.css">
    <!-- RECUERDA AÑADIR LA NUEVA HOJA DE ESTILOS -->
    <link rel="stylesheet" href="form-styles.css">
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen">

    <!-- Navbar placeholder -->
    <div id="navbar-placeholder"></div>

    <!-- Contenido Principal -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 sm:p-6 lg:p-8">
            
            <div class="text-center mb-6 border-b border-gray-200 dark:border-gray-700 pb-4">
                <h1 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white">INSPECCIÓN DE HERRAMIENTAS MANUALES</h1>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">FTO-AL10195-24 / Versión 03</p>
            </div>

            <form id="checklistForm" class="space-y-6">
                <!-- SECCIÓN DE DATOS GENERALES -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Contrato:</label>
                        <p class="text-sm text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                            "Suministro de Puertas Bidireccionales de Control en 7 Estaciones de la Red de Metro"
                        </p>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="sitio" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Sitio/Lugar/Agencia:</label>
                            <select id="sitio" name="sitio" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Seleccione un sitio...</option>
                                <option value="Santa Julia Linea 4A">Santa Julia Linea 4A</option>
                                <option value="San Ramon Linea 4A">San Ramon Linea 4A</option>
                                <option value="La Granja Linea 4A">La Granja Linea 4A</option>
                                <option value="Departamental Linea 2">Departamental Linea 2</option>
                                <option value="Universidad de Chile Linea 1">Universidad de Chile Linea 1</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="fechaInspeccion" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Fecha de Inspección:</label>
                            <input type="date" id="fechaInspeccion" name="fechaInspeccion" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500" readonly>
                        </div>
                    </div>
                    
                    <div>
                        <label for="trabajador" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nombre del Trabajador:</label>
                        <select id="trabajador" name="trabajador" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Seleccione un trabajador...</option>
                            <option value="Nestor Flores">Nestor Flores</option>
                            <option value="Ronald Cancino">Ronald Cancino</option>
                            <option value="Nicolas Jara">Nicolas Jara</option>
                            <option value="Juan Carlos Valenzuela">Juan Carlos Valenzuela</option>
                            <option value="Avelino Troncoso">Avelino Troncoso</option>
                            <option value="Ronald Rodriguez">Ronald Rodriguez</option>
                        </select>
                    </div>
                </div>

                <!-- SECCIÓN DE HERRAMIENTAS MANUALES -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 bg-gray-100 dark:bg-gray-700 p-3 rounded-lg">1. Herramientas Manuales</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm border-collapse">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="p-2 text-left text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600">Ítem</th>
                                    <th class="p-2 text-left text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 table-cell-md">Herramienta</th>
                                    <th class="p-2 text-center text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 table-cell-sm">Estado<br>(B/M/N/A)</th>
                                    <th class="p-2 text-center text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 table-cell-sm">Color Mes<br>(Sí/No)</th>
                                    <th class="p-2 text-left text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 table-cell-lg">Observaciones</th>
                                </tr>
                            </thead>
                            <tbody id="herramientasTableBody" class="bg-white dark:bg-gray-800">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- SECCIÓN OTRAS HERRAMIENTAS -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 bg-gray-100 dark:bg-gray-700 p-3 rounded-lg">2. Otras Herramientas</h3>
                    <div id="otras-herramientas-container" class="space-y-4"></div>
                    <button type="button" id="add-tool-btn" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm transition-colors">
                        + Agregar Herramienta
                    </button>
                </div>

                <!-- SECCIÓN PLAN DE ACCIÓN -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 bg-gray-100 dark:bg-gray-700 p-3 rounded-lg">3. Plan de Acción (No obligatorio)</h3>
                    <div id="plan-accion-container" class="space-y-4">
                        <!-- Las filas del plan de acción se generarán aquí -->
                    </div>
                </div>

                <!-- SECCIÓN DE FIRMAS -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <div class="text-center space-y-3">
                        <div class="bg-gray-100 dark:bg-gray-700 p-2 rounded-lg">
                            <h4 class="font-semibold text-gray-900 dark:text-white">Realizó</h4>
                        </div>
                        <div class="signature-pad-container">
                            <canvas id="firmaRealizoPad"></canvas>
                            <button type="button" class="clear-btn px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600" data-target="firmaRealizoPad">Limpiar</button>
                        </div>
                        <p id="nombreRealizo" class="font-semibold text-gray-900 dark:text-white">Nombre del Trabajador</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Técnico Montajista</p>
                        <input type="date" id="fechaRealizo" name="fechaRealizo" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white" readonly>
                    </div>

                    <div class="text-center space-y-3">
                        <div class="bg-gray-100 dark:bg-gray-700 p-2 rounded-lg">
                            <h4 class="font-semibold text-gray-900 dark:text-white">Revisó</h4>
                        </div>
                        <div class="signature-pad-container">
                            <canvas id="firmaRevisoPad"></canvas>
                            <button type="button" class="clear-btn px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600" data-target="firmaRevisoPad">Limpiar</button>
                        </div>
                        <p class="font-semibold text-gray-900 dark:text-white">Guillermo Osorio</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Supervisor</p>
                        <input type="date" id="fechaReviso" name="fechaReviso" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white" readonly>
                    </div>

                    <div class="text-center space-y-3">
                        <div class="bg-gray-100 dark:bg-gray-700 p-2 rounded-lg">
                            <h4 class="font-semibold text-gray-900 dark:text-white">V°B° Prevención de Riesgos</h4>
                        </div>
                        <div class="signature-pad-container">
                            <canvas id="firmaPrevencionPad"></canvas>
                            <button type="button" class="clear-btn px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600" data-target="firmaPrevencionPad">Limpiar</button>
                        </div>
                        <select id="prevencionista" name="prevencionista" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white" required>
                            <option value="">Seleccione...</option>
                            <option value="Valeria Huichipan">Valeria Huichipan</option>
                            <option value="Luis Sepúlveda">Luis Sepúlveda</option>
                        </select>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Prevención de Riesgos</p>
                        <input type="date" id="fechaPrevencion" name="fechaPrevencion" class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white" readonly>
                    </div>
                </div>

                <div class="pt-6">
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg text-lg transition-colors duration-200">
                        Guardar y Enviar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="navbar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script type="module">
    
        import { db } from './firebase-config.js'; 
        import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', function () {
            // --- Lógica del Formulario (Actualizada) ---
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fechaInspeccion').value = today;
            document.getElementById('fechaRealizo').value = today;
            document.getElementById('fechaReviso').value = today;
            document.getElementById('fechaPrevencion').value = today;

            const trabajadorSelect = document.getElementById('trabajador');
            const nombreRealizo = document.getElementById('nombreRealizo');
            trabajadorSelect.addEventListener('change', function() {
                nombreRealizo.textContent = this.value || 'Nombre del Trabajador';
            });
            
            // --- Carga de Herramientas Predeterminadas ---
            const herramientas = [
                "Caja Herramientas negra", "Juego de Dados 36 piezas", "Alicate Universal", 
                "Alicate Punta", "Alicate Cortante", "Caiman", "Flexometro", "Juego de dados", 
                "Atornillador de Paleta aislado 1,2x6,5x150mm", "Atornillador de Paleta aislado 1,0x5,5x125mm", 
                "Atornillador de Paleta aislado 0,8x4,0x100mm", "Atornillador de Paleta aislado 0,4x2,5x75mm", 
                "Atornillador de cruz aislado PH2x100mm", "Atornillador de cruz aislado PH1x80mm", 
                "Atornillador de cruz aislado PH0x75mm", "Crimpeadora", "Ventosa para pisos tecnicos", "Martillo"
            ];

            const tbody = document.getElementById('herramientasTableBody');
            herramientas.forEach((herramienta, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border border-gray-200 dark:border-gray-700';
                // ***** INICIO DE LA MODIFICACIÓN *****
                // Se añaden los atributos data-label para la vista móvil
                tr.innerHTML = `
                    <td data-label="Ítem" class="p-2 text-gray-900 dark:text-white border border-gray-300 dark:border-gray-600">1.${index + 1}</td>
                    <td data-label="Herramienta" class="p-2 text-gray-900 dark:text-white border border-gray-300 dark:border-gray-600">${herramienta}</td>
                    <td data-label="Estado (B/M/N/A)" class="p-2 text-center border border-gray-300 dark:border-gray-600">
                        <div class="flex justify-center items-center space-x-2 sm:space-x-4 text-xs sm:text-sm">
                            <label class="flex items-center cursor-pointer"><input type="radio" name="estado_${index}" value="Bueno" required class="mr-1"> B</label>
                            <label class="flex items-center cursor-pointer"><input type="radio" name="estado_${index}" value="Malo" class="mr-1"> M</label>
                            <label class="flex items-center cursor-pointer"><input type="radio" name="estado_${index}" value="N/A" class="mr-1"> N/A</label>
                        </div>
                    </td>
                    <td data-label="Color Mes (Sí/No)" class="p-2 text-center border border-gray-300 dark:border-gray-600">
                        <div class="flex justify-center items-center space-x-2 sm:space-x-4 text-xs sm:text-sm">
                            <label class="flex items-center cursor-pointer"><input type="radio" name="color_${index}" value="Si" required class="mr-1"> Sí</label>
                            <label class="flex items-center cursor-pointer"><input type="radio" name="color_${index}" value="No" class="mr-1"> No</label>
                        </div>
                    </td>
                    <td data-label="Observaciones" class="p-2 border border-gray-300 dark:border-gray-600"><input type="text" name="obs_${index}" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm"></td>
                `;
                // ***** FIN DE LA MODIFICACIÓN *****
                tbody.appendChild(tr);
            });

            // --- Lógica para "Agregar Otra Herramienta" ---
            const addToolBtn = document.getElementById('add-tool-btn');
            const otrasContainer = document.getElementById('otras-herramientas-container');
            let otherToolIndex = 0;

            addToolBtn.addEventListener('click', () => {
                otherToolIndex++;
                const toolDiv = document.createElement('div');
                toolDiv.className = 'grid grid-cols-1 sm:grid-cols-12 gap-2 p-2 border rounded-lg border-gray-300 dark:border-gray-600 items-center';
                toolDiv.innerHTML = `
                    <div class="sm:col-span-4">
                        <input type="text" name="otraHerramientaNombre_${otherToolIndex}" placeholder="Nombre de la herramienta" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-sm" required>
                    </div>
                    <div class="sm:col-span-3">
                         <div class="flex justify-center items-center space-x-2 text-xs sm:text-sm">
                            <label class="flex items-center cursor-pointer"><input type="radio" name="otraHerramientaEstado_${otherToolIndex}" value="Bueno" required class="mr-1"> B</label>
                            <label class="flex items-center cursor-pointer"><input type="radio" name="otraHerramientaEstado_${otherToolIndex}" value="Malo" class="mr-1"> M</label>
                            <label class="flex items-center cursor-pointer"><input type="radio" name="otraHerramientaEstado_${otherToolIndex}" value="N/A" class="mr-1"> N/A</label>
                        </div>
                    </div>
                    <div class="sm:col-span-2">
                        <div class="flex justify-center items-center space-x-2 text-xs sm:text-sm">
                            <label class="flex items-center cursor-pointer"><input type="radio" name="otraHerramientaColor_${otherToolIndex}" value="Si" required class="mr-1"> Sí</label>
                            <label class="flex items-center cursor-pointer"><input type="radio" name="otraHerramientaColor_${otherToolIndex}" value="No" class="mr-1"> No</label>
                        </div>
                    </div>
                    <div class="sm:col-span-2">
                        <input type="text" name="otraHerramientaObs_${otherToolIndex}" placeholder="Observación" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-sm">
                    </div>
                    <div class="sm:col-span-1 text-right">
                        <button type="button" class="remove-tool-btn p-2 text-red-500 hover:text-red-700">&times;</button>
                    </div>
                `;
                otrasContainer.appendChild(toolDiv);
            });
            
            otrasContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-tool-btn')) {
                    e.target.closest('.grid').remove();
                }
            });

            // --- Lógica para "Plan de Acción" ---
            const planContainer = document.getElementById('plan-accion-container');
            for (let i = 0; i < 3; i++) {
                const planDiv = document.createElement('div');
                planDiv.className = 'grid grid-cols-1 sm:grid-cols-3 gap-4';
                planDiv.innerHTML = `
                    <div>
                        <label class="sr-only">Plan ${i+1}</label>
                        <input type="text" name="planAccion_${i}" placeholder="Plan de Acción ${i+1}" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm">
                    </div>
                    <div>
                        <label class="sr-only">Fecha Plan ${i+1}</label>
                        <input type="date" name="fechaPlan_${i}" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm">
                    </div>
                    <div>
                        <label class="sr-only">Responsable ${i+1}</label>
                        <input type="text" name="responsablePlan_${i}" placeholder="Responsable ${i+1}" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm">
                    </div>
                `;
                planContainer.appendChild(planDiv);
            }

            // --- Configuración de Firmas (sin cambios) ---
            function setupSignaturePad(canvasId) {
                const canvas = document.getElementById(canvasId);
                const signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(249, 250, 251)' });
                
                function resizeCanvas() {
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    canvas.width = canvas.offsetWidth * ratio;
                    canvas.height = canvas.offsetHeight * ratio;
                    canvas.getContext("2d").scale(ratio, ratio);
                    signaturePad.clear();
                }
                
                window.addEventListener("resize", resizeCanvas);
                resizeCanvas();
                return signaturePad;
            }

            const firmaRealizo = setupSignaturePad('firmaRealizoPad');
            const firmaReviso = setupSignaturePad('firmaRevisoPad');
            const firmaPrevencion = setupSignaturePad('firmaPrevencionPad');

            document.querySelectorAll('.clear-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const targetId = e.currentTarget.getAttribute('data-target');
                    if (targetId === 'firmaRealizoPad') firmaRealizo.clear();
                    if (targetId === 'firmaRevisoPad') firmaReviso.clear();
                    if (targetId === 'firmaPrevencionPad') firmaPrevencion.clear();
                });
            });
            
            // --- Envío del Formulario (Actualizado) ---
            document.getElementById('checklistForm').addEventListener('submit', async function(event) {
                event.preventDefault();
                const submitButton = event.currentTarget.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = 'Enviando...';

                // Recolectar datos del formulario
                const form = event.target;
                const data = new FormData(form);

                const formData = {
                    contrato: "Suministro de Puertas Bidireccionales de Control en 7 Estaciones de la Red de Metro",
                    sitio: data.get('sitio'),
                    fechaInspeccion: data.get('fechaInspeccion'),
                    trabajador: data.get('trabajador'),
                    prevencionista: data.get('prevencionista'),
                    herramientas: [],
                    otrasHerramientas: [],
                    planAccion: [],
                    firmaRealizoImg: firmaRealizo.isEmpty() ? "" : firmaRealizo.toDataURL(),
                    firmaRevisoImg: firmaReviso.isEmpty() ? "" : firmaReviso.toDataURL(),
                    firmaPrevencionImg: firmaPrevencion.isEmpty() ? "" : firmaPrevencion.toDataURL()
                };

                // Recolectar herramientas predeterminadas
                herramientas.forEach((herramienta, index) => {
                    formData.herramientas.push({
                        nombre: herramienta,
                        estado: data.get(`estado_${index}`) || 'N/A',
                        color: data.get(`color_${index}`) || 'No',
                        obs: data.get(`obs_${index}`)
                    });
                });

                // Recolectar otras herramientas
                const otrasHerramientasDivs = otrasContainer.querySelectorAll('.grid');
                otrasHerramientasDivs.forEach((div, index) => {
                    const nombreInput = div.querySelector('input[name^="otraHerramientaNombre"]');
                    const nombre = nombreInput ? nombreInput.value : '';

                    if(nombre) { // Solo agregar si tiene nombre
                        formData.otrasHerramientas.push({
                            nombre: nombre,
                            estado: div.querySelector('input[name^="otraHerramientaEstado"]:checked')?.value || 'N/A',
                            color: div.querySelector('input[name^="otraHerramientaColor"]:checked')?.value || 'No',
                            obs: div.querySelector('input[name^="otraHerramientaObs"]')?.value || ''
                        });
                    }
                });

                // Recolectar plan de acción
                for (let i = 0; i < 3; i++) {
                    const accion = data.get(`planAccion_${i}`);
                    if (accion) { // Solo agregar si hay una acción descrita
                        formData.planAccion.push({
                            accion: accion,
                            fecha: data.get(`fechaPlan_${i}`),
                            responsable: data.get(`responsablePlan_${i}`)
                        });
                    }
                }

                // URL de Pipedream (Webhook)
                const pipedreamUrl = "https://eo4hxb3eilspbb0.m.pipedream.net";

                try {
                    const response = await fetch(pipedreamUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        alert('¡Checklist enviado con éxito!');
                        form.reset();
                        nombreRealizo.textContent = 'Nombre del Trabajador';
                        firmaRealizo.clear();
                        firmaReviso.clear();
                        firmaPrevencion.clear();
                        otrasContainer.innerHTML = '';
                    } else {
                        const errorText = await response.text();
                        throw new Error(`El servidor respondió con un error: ${response.status}. ${errorText}`);
                    }
                } catch (error) {
                    console.error("Error al enviar el formulario:", error);
                    alert("Hubo un error al enviar el checklist. Por favor, revisa la consola para más detalles.");
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Guardar y Enviar';
                }
            });
        });
    </script>
</body>
</html>
