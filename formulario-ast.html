<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Análisis de Seguridad en el Trabajo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Navbar placeholder -->
    <div id="navbar-placeholder"></div>

    <!-- Contenido Principal del Formulario -->
    <main class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8 min-h-screen">
        <form id="astForm" class="form-container fade-in">
            
            <!-- Cabecera del Formulario -->
            <div class="form-header">
                <h2>ANÁLISIS DE SEGURIDAD EN EL TRABAJO (AST)</h2>
                <p>FTO-AL10195-01</p>
                <div class="mt-4">
                    <div class="timestamp-badge">
                        Fecha y hora de creación: <span id="fechaHoraActual" class="font-bold"></span>
                    </div>
                </div>
            </div>

            <!-- 1. Información General -->
            <section class="form-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <span class="section-icon">1</span>
                        Información General del Trabajo
                    </h3>
                </div>
                
                <div class="form-grid form-grid-3">
                    <div>
                        <label for="empresa" class="form-label required-field">Empresa</label>
                        <input type="text" id="empresa" name="empresa" class="form-input" value="SICE AGENCIA CHILE S.A" readonly>
                    </div>
                    <div class="md:col-span-2">
                        <label for="obra_area" class="form-label required-field">OBRA/Área</label>
                        <input type="text" id="obra_area" name="obra_area" class="form-input" value="Suministro de Puertas Bidireccionales de Control en 7 Estaciones de la Red de Metro." readonly>
                    </div>
                </div>

                <div class="form-grid form-grid-2" style="margin-top: 1.5rem;">
                    <div class="md:col-span-2">
                        <label for="lugar" class="form-label required-field">Lugar Específico</label>
                        <select id="lugar" name="lugar" class="form-select" required>
                            <option value="">Seleccione una estación...</option>
                            <option value="Estacion Universidad de Chile">Estación Universidad de Chile</option>
                            <option value="Estacion San Pablo">Estación San Pablo</option>
                            <option value="Estacion Departamental">Estación Departamental</option>
                            <option value="Estacion Santa Julia">Estación Santa Julia</option>
                            <option value="Estacion San Ramon">Estación San Ramón</option>
                            <option value="Estacion San Joaquin">Estación San Joaquín</option>
                            <option value="Estacion La Granja">Estación La Granja</option>
                        </select>
                    </div>
                </div>

                <div style="margin-top: 1.5rem;">
                    <label for="trabajo" class="form-label required-field">Trabajo a Realizar</label>
                    <textarea id="trabajo" name="trabajo" class="form-textarea" placeholder="Describa detalladamente el trabajo que se va a realizar..."></textarea>
                </div>
            </section>

            <!-- 2. Documento de Respaldo -->
            <section class="form-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <span class="section-icon">2</span>
                        Documento de Respaldo
                    </h3>
                </div>
                
                <div id="documentos-container">
                    <div class="form-grid form-grid-2" id="documento-inicial">
                        <div>
                            <label for="tipoDocumento" class="form-label">Tipo de Documento</label>
                            <select id="tipoDocumento" name="tipoDocumento" class="form-select">
                                <option value="">Seleccione tipo de documento...</option>
                                <option value="procedimiento">Procedimiento</option>
                                <option value="instructivo">Instructivo</option>
                                <option value="otro">Otro</option>
                                <option value="no_requiere">No requiere</option>
                            </select>
                        </div>
                        <div>
                            <label for="nombreCodigo" class="form-label">Nombre o Código del Documento</label>
                            <input type="text" id="nombreCodigo" name="nombreCodigo" class="form-input" placeholder="Ingrese nombre o código del documento">
                        </div>
                    </div>
                    <div id="documentos-adicionales" style="margin-top: 1rem;">
                        <!-- Documentos adicionales se agregarán aquí -->
                    </div>
                </div>
                <button type="button" id="add-documento-button" class="btn btn-secondary" style="margin-top: 1rem;">
                    + Agregar Otro Documento de Respaldo
                </button>
            </section>

            <!-- 3. Elementos de Apoyo -->
            <section class="form-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <span class="section-icon">3</span>
                        Elementos de Apoyo para el Control de los Riesgos
                    </h3>
                </div>
                
                <div id="epp-container">
                    <!-- EPP predeterminados -->
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input id="casco" name="epp_predeterminado" type="checkbox" value="Casco">
                            <label for="casco">Casco</label>
                        </div>
                        <div class="checkbox-item">
                            <input id="linterna_casco" name="epp_predeterminado" type="checkbox" value="Linterna Adosable al Casco">
                            <label for="linterna_casco">Linterna Adosable al Casco</label>
                        </div>
                        <div class="checkbox-item">
                            <input id="lentes" name="epp_predeterminado" type="checkbox" value="Lentes de seguridad">
                            <label for="lentes">Lentes de seguridad</label>
                        </div>
                        <div class="checkbox-item">
                            <input id="zapatos" name="epp_predeterminado" type="checkbox" value="Zapatos de seguridad">
                            <label for="zapatos">Zapatos de seguridad</label>
                        </div>
                        <div class="checkbox-item">
                            <input id="guantes" name="epp_predeterminado" type="checkbox" value="Guantes">
                            <label for="guantes">Guantes</label>
                        </div>
                        <div class="checkbox-item">
                            <input id="guantes_hyflex" name="epp_predeterminado" type="checkbox" value="Guantes Hyflex">
                            <label for="guantes_hyflex">Guantes Hyflex</label>
                        </div>
                        <div class="checkbox-item">
                            <input id="guantes_cabritilla" name="epp_predeterminado" type="checkbox" value="Guantes Cabritilla">
                            <label for="guantes_cabritilla">Guantes Cabritilla</label>
                        </div>
                        <div class="checkbox-item">
                            <input id="protector_auditivo" name="epp_predeterminado" type="checkbox" value="Protector auditivo">
                            <label for="protector_auditivo">Protector auditivo</label>
                        </div>
                        <div class="checkbox-item">
                            <input id="protector_respiratorio" name="epp_predeterminado" type="checkbox" value="Protector respiratorio">
                            <label for="protector_respiratorio">Protector respiratorio</label>
                        </div>
                        <div class="checkbox-item">
                            <input id="arnes" name="epp_predeterminado" type="checkbox" value="Arnés de seguridad">
                            <label for="arnes">Arnés de seguridad</label>
                        </div>
                        <div class="checkbox-item">
                            <input id="cono" name="epp_predeterminado" type="checkbox" value="Cono">
                            <label for="cono">Cono</label>
                        </div>
                        <div class="checkbox-item">
                            <input id="taladro_inalambrico" name="epp_predeterminado" type="checkbox" value="Taladro Inalámbrico">
                            <label for="taladro_inalambrico">Taladro Inalámbrico</label>
                        </div>
                    </div>
                    
                    <!-- EPP adicionales -->
                    <div id="epp-adicionales" style="margin-top: 1.5rem;">
                        <h4 style="font-weight: 600; margin-bottom: 1rem; color: var(--neutral-700);">Elementos Adicionales</h4>
                    </div>
                </div>
                <button type="button" id="add-epp-button" class="btn btn-success" style="margin-top: 1rem;">
                    + Agregar Elemento Adicional
                </button>
            </section>

            <!-- 4. Secuencia del Trabajo -->
            <section class="form-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <span class="section-icon">4</span>
                        Secuencia de las Etapas del Trabajo
                    </h3>
                </div>
                <div id="etapas-container">
                    <!-- Las etapas se generarán dinámicamente -->
                </div>
                <button type="button" id="add-etapa-button" class="btn btn-secondary" style="margin-top: 1.5rem;">
                    + Agregar Otra Etapa
                </button>
            </section>

            <!-- 5. Personal Participante -->
           <section class="form-section">
    <div class="section-header">
        <h3 class="section-title">
            <span class="section-icon">5</span>
            Personal que Participa en la Actividad
        </h3>
    </div>
    
    <!-- Contenedor de personal con cards en lugar de tabla -->
    <div id="personal-cards-container" class="space-y-4">
        <!-- Las tarjetas de personal se generarán aquí dinámicamente -->
    </div>
    
    <!-- Versión alternativa con tabla mejorada (comentada por defecto) -->
    <div id="personal-table-version" class="hidden">
        <div class="table-container-personal">
            <div class="table-responsive">
                <table class="personal-table">
                    <thead>
                        <tr>
                            <th class="personal-name-col">Nombre Completo</th>
                            <th class="personal-rut-col">RUT</th>
                            <th class="personal-signature-col">Firma</th>
                            <th class="personal-actions-col"></th>
                        </tr>
                    </thead>
                    <tbody id="personal-table-body">
                        <!-- Filas de personal se agregarán aquí -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <button type="button" id="add-personal-button" class="btn btn-primary mt-4">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        Añadir Persona
    </button>
</section>

            <!-- 6. Firmas -->
            <section class="form-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <span class="section-icon">6</span>
                        Firmas de Autorización
                    </h3>
                </div>
                <div class="form-grid form-grid-2">
                    <div style="text-align: center;">
                        <label class="form-label">Supervisor a Cargo</label>
                        <div class="signature-container">
                            <canvas id="signature-supervisor"></canvas>
                            <button type="button" onclick="clearSignature('signature-supervisor')" class="btn btn-danger" style="position: absolute; top: 8px; right: 8px; padding: 0.25rem 0.5rem; font-size: 0.75rem;">Limpiar</button>
                        </div>
                        <p style="font-weight: 600; margin-top: 1rem;">Guillermo Osorio</p>
                        <p style="font-size: 0.875rem; color: var(--neutral-500);">Supervisor</p>
                    </div>

                    <div style="text-align: center;">
                        <label class="form-label">Prevencionista de Riesgos (APR)</label>
                        <div class="signature-container">
                            <canvas id="signature-apr"></canvas>
                            <button type="button" onclick="clearSignature('signature-apr')" class="btn btn-danger" style="position: absolute; top: 8px; right: 8px; padding: 0.25rem 0.5rem; font-size: 0.75rem;">Limpiar</button>
                        </div>
                        <select id="prevencionista" name="prevencionista" class="form-select" style="max-width: 300px; margin: 1rem auto;" required>
                            <option value="">Seleccione prevencionista...</option>
                            <option value="Luis Sepúlveda">Luis Sepúlveda</option>
                            <option value="Valeria Huichipan">Valeria Huichipan</option>
                        </select>
                        <p style="font-size: 0.875rem; color: var(--neutral-500);">Prevención de Riesgos</p>
                    </div>
                </div>
            </section>

            <!-- Botones de Acción -->
            <div class="form-section">
                <div style="display: flex; flex-direction: column; gap: 1rem; padding-top: 2rem; border-top: 1px solid var(--neutral-200);">
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <button type="button" class="btn btn-secondary">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Guardar y Enviar
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </main>

    <!-- Scripts -->
    <script src="navbar.js"></script>
    <script>
        // Lista de riesgos potenciales
        const riesgosPotenciales = [
            "Atrapado por objeto en movimiento",
            "Atrapado entre objetos",
            "Caída a mismo nivel",
            "Caída a distinto nivel", 
            "Caída de objetos",
            "Contacto con electricidad",
            "Contacto con sustancias químicas",
            "Contacto con superficies calientes",
            "Contacto con superficies frías",
            "Cortes y laceraciones",
            "Exposición a ruido",
            "Exposición a vibraciones",
            "Exposición a radiaciones",
            "Exposición a temperatura extrema",
            "Golpes contra objetos",
            "Golpes por objetos",
            "Incendio",
            "Explosión",
            "Intoxicación por gases",
            "Lesiones ergonómicas",
            "Proyección de partículas",
            "Sobreesfuerzo físico",
            "Contacto con herramientas cortantes",
            "Pisadas sobre objetos",
            "Contacto con materiales abrasivos"
        ];

        // Inicializar fecha y hora actual
        function setCurrentDateTime() {
            const now = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit',
                timeZone: 'America/Santiago'
            };
            document.getElementById('fechaHoraActual').textContent = now.toLocaleDateString('es-CL', options);
        }

        // --- Lógica para los Canvas de Firma ---
        function setupSignaturePad(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            let drawing = false;

            function resizeCanvas() {
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
            }
            
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            function getMousePos(evt) {
                const rect = canvas.getBoundingClientRect();
                return {
                    x: evt.clientX - rect.left,
                    y: evt.clientY - rect.top
                };
            }
            
            function getTouchPos(evt) {
                const rect = canvas.getBoundingClientRect();
                return {
                    x: evt.touches[0].clientX - rect.left,
                    y: evt.touches[0].clientY - rect.top
                };
            }

            function startDrawing(e) {
                drawing = true;
                const pos = e.type.includes('touch') ? getTouchPos(e) : getMousePos(e);
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
            }

            function draw(e) {
                if (!drawing) return;
                e.preventDefault();
                const pos = e.type.includes('touch') ? getTouchPos(e) : getMousePos(e);
                ctx.lineTo(pos.x, pos.y);
                ctx.strokeStyle = '#1e40af';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.stroke();
            }

            function stopDrawing() {
                drawing = false;
                ctx.closePath();
            }

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseleave', stopDrawing);
            
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);
        }

        window.clearSignature = function(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // --- Lógica para documentos adicionales ---
        let documentoCount = 0;
        document.getElementById('add-documento-button').addEventListener('click', function() {
            documentoCount++;
            const docDiv = document.createElement('div');
            docDiv.className = 'form-grid form-grid-2';
            docDiv.style.marginTop = '1rem';
            docDiv.style.padding = '1rem';
            docDiv.style.border = '1px solid var(--neutral-200)';
            docDiv.style.borderRadius = '8px';
            docDiv.style.background = 'var(--neutral-50)';
            docDiv.style.position = 'relative';
            docDiv.innerHTML = `
                <div>
                    <label class="form-label">Tipo de Documento</label>
                    <select name="tipoDocumento_adicional_${documentoCount}" class="form-select">
                        <option value="">Seleccione tipo de documento...</option>
                        <option value="procedimiento">Procedimiento</option>
                        <option value="instructivo">Instructivo</option>
                        <option value="otro">Otro</option>
                        <option value="no_requiere">No requiere</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">Nombre o Código del Documento</label>
                    <input type="text" name="nombreCodigo_adicional_${documentoCount}" class="form-input" placeholder="Ingrese nombre o código del documento">
                </div>
                <button type="button" class="btn btn-danger remove-documento-btn" style="position: absolute; top: 8px; right: 8px; padding: 0.25rem 0.5rem; font-size: 0.75rem;">&times;</button>
            `;
            document.getElementById('documentos-adicionales').appendChild(docDiv);
        });

        document.getElementById('documentos-adicionales').addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-documento-btn')) {
                e.target.closest('div').remove();
            }
        });

        // --- Lógica para EPP adicionales ---
        let eppCount = 0;
        document.getElementById('add-epp-button').addEventListener('click', function() {
            eppCount++;
            const eppDiv = document.createElement('div');
            eppDiv.className = 'form-grid form-grid-2';
            eppDiv.style.marginTop = '1rem';
            eppDiv.style.padding = '1rem';
            eppDiv.style.border = '1px solid var(--neutral-200)';
            eppDiv.style.borderRadius = '8px';
            eppDiv.style.background = 'var(--neutral-50)';
            eppDiv.style.position = 'relative';
            eppDiv.innerHTML = `
                <div>
                    <input type="text" placeholder="Nombre del Elemento" name="epp_adicional_${eppCount}" class="form-input" required>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="epp_adicional_check_${eppCount}" name="epp_adicional_check_${eppCount}" style="width: 1rem; height: 1rem; accent-color: var(--primary-color);">
                    <label for="epp_adicional_check_${eppCount}" class="form-label" style="margin: 0;">Usar</label>
                </div>
                <button type="button" class="btn btn-danger remove-epp-btn" style="position: absolute; top: 8px; right: 8px; padding: 0.25rem 0.5rem; font-size: 0.75rem;">&times;</button>
            `;
            document.getElementById('epp-adicionales').appendChild(eppDiv);
        });

        document.getElementById('epp-adicionales').addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-epp-btn')) {
                e.target.closest('div').remove();
            }
        });


// ====================================================================
// JAVASCRIPT PARA MANEJO DE PERSONAL MEJORADO
// ====================================================================

let personalCount = 0;
const useCardLayout = true; // Cambiar a false para usar tabla

// Función para crear una nueva tarjeta de personal
function createPersonalCard() {
    personalCount++;
    const cardDiv = document.createElement('div');
    cardDiv.className = 'personal-card personal-card-enter';
    cardDiv.setAttribute('data-personal-id', personalCount);
    
    cardDiv.innerHTML = `
        <div class="personal-card-header">
            <h4 class="personal-card-title">Persona ${personalCount}</h4>
            <button type="button" class="personal-remove-btn" onclick="removePersonalCard(${personalCount})">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <div class="personal-card-content">
            <div class="personal-field">
                <label for="personal_nombre_${personalCount}">Nombre Completo *</label>
                <input 
                    type="text" 
                    id="personal_nombre_${personalCount}"
                    name="personal_nombre_${personalCount}" 
                    placeholder="Nombre y Apellido"
                    required
                >
            </div>
            
            <div class="personal-field">
                <label for="personal_rut_${personalCount}">RUT *</label>
                <input 
                    type="text" 
                    id="personal_rut_${personalCount}"
                    name="personal_rut_${personalCount}" 
                    placeholder="12.345.678-9"
                    required
                >
            </div>
            
            <div class="personal-signature-area">
                <label class="personal-signature-label">Firma Digital</label>
                <div class="personal-signature-container" id="signature-container-${personalCount}">
                    <canvas 
                        id="firma-personal-${personalCount}" 
                        class="personal-signature-canvas"
                    ></canvas>
                    <div class="personal-signature-placeholder" id="placeholder-${personalCount}">
                        Haga clic aquí para firmar
                    </div>
                    <button 
                        type="button" 
                        class="personal-signature-clear" 
                        onclick="clearPersonalSignature(${personalCount})"
                        style="display: none;"
                        id="clear-btn-${personalCount}"
                    >
                        Limpiar
                    </button>
                </div>
            </div>
        </div>
    `;
    
    return cardDiv;
}

// Función para crear fila de tabla (versión alternativa)
function createPersonalRow() {
    personalCount++;
    const row = document.createElement('tr');
    row.setAttribute('data-personal-id', personalCount);
    
    row.innerHTML = `
        <td>
            <input 
                type="text" 
                placeholder="Nombre y Apellido" 
                name="personal_nombre_${personalCount}" 
                class="form-input" 
                required
            >
        </td>
        <td>
            <input 
                type="text" 
                placeholder="12.345.678-9" 
                name="personal_rut_${personalCount}" 
                class="form-input" 
                required
            >
        </td>
        <td>
            <div class="table-signature-container">
                <canvas id="firma-personal-${personalCount}" class="personal-signature-canvas"></canvas>
                <button 
                    type="button" 
                    onclick="clearPersonalSignature(${personalCount})" 
                    class="personal-signature-clear"
                    style="display: none;"
                    id="clear-btn-${personalCount}"
                >
                    ×
                </button>
            </div>
        </td>
        <td style="text-align: center;">
            <button 
                type="button" 
                class="btn btn-danger remove-personal-button" 
                onclick="removePersonalRow(${personalCount})"
                style="padding: 0.5rem;"
            >
                ×
            </button>
        </td>
    `;
    
    return row;
}

// Función para añadir personal
function addPersonal() {
    if (useCardLayout) {
        const container = document.getElementById('personal-cards-container');
        const card = createPersonalCard();
        container.appendChild(card);
    } else {
        const tbody = document.getElementById('personal-table-body');
        const row = createPersonalRow();
        tbody.appendChild(row);
    }
    
    // Configurar canvas de firma después de un breve delay
    setTimeout(() => {
        setupPersonalSignaturePad(`firma-personal-${personalCount}`);
    }, 100);
}

// Función para remover tarjeta de personal
function removePersonalCard(personalId) {
    const card = document.querySelector(`[data-personal-id="${personalId}"]`);
    if (card) {
        card.classList.add('personal-card-remove');
        setTimeout(() => {
            card.remove();
        }, 300);
    }
}

// Función para remover fila de personal
function removePersonalRow(personalId) {
    const row = document.querySelector(`[data-personal-id="${personalId}"]`);
    if (row) {
        row.remove();
    }
}

// Función para configurar canvas de firma personal
function setupPersonalSignaturePad(canvasId) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const personalId = canvasId.split('-')[2];
    const container = document.getElementById(`signature-container-${personalId}`);
    const placeholder = document.getElementById(`placeholder-${personalId}`);
    const clearBtn = document.getElementById(`clear-btn-${personalId}`);
    
    let drawing = false;
    let hasSignature = false;

    function resizeCanvas() {
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
    }
    
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function getEventPos(evt) {
        const rect = canvas.getBoundingClientRect();
        const clientX = evt.clientX || (evt.touches && evt.touches[0].clientX);
        const clientY = evt.clientY || (evt.touches && evt.touches[0].clientY);
        return {
            x: clientX - rect.left,
            y: clientY - rect.top
        };
    }

    function startDrawing(e) {
        drawing = true;
        const pos = getEventPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        
        if (!hasSignature) {
            hasSignature = true;
            placeholder.style.display = 'none';
            clearBtn.style.display = 'block';
            container.classList.add('has-signature');
        }
    }

    function draw(e) {
        if (!drawing) return;
        e.preventDefault();
        const pos = getEventPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.strokeStyle = '#1e40af';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.stroke();
    }

    function stopDrawing() {
        drawing = false;
        ctx.closePath();
    }

    // Event listeners para mouse
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseleave', stopDrawing);
    
    // Event listeners para touch
    canvas.addEventListener('touchstart', startDrawing);
    canvas.addEventListener('touchmove', draw);
    canvas.addEventListener('touchend', stopDrawing);
}

// Función para limpiar firma personal
function clearPersonalSignature(personalId) {
    const canvas = document.getElementById(`firma-personal-${personalId}`);
    const container = document.getElementById(`signature-container-${personalId}`);
    const placeholder = document.getElementById(`placeholder-${personalId}`);
    const clearBtn = document.getElementById(`clear-btn-${personalId}`);
    
    if (canvas && container) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        container.classList.remove('has-signature');
        if (placeholder) placeholder.style.display = 'block';
        if (clearBtn) clearBtn.style.display = 'none';
    }
}

// Event listener para el botón de añadir personal
document.addEventListener('DOMContentLoaded', function() {
    const addPersonalBtn = document.getElementById('add-personal-button');
    if (addPersonalBtn) {
        addPersonalBtn.addEventListener('click', addPersonal);
    }
    
    // Mostrar el layout correcto
    if (useCardLayout) {
        document.getElementById('personal-cards-container').classList.remove('hidden');
        document.getElementById('personal-table-version').classList.add('hidden');
    } else {
        document.getElementById('personal-cards-container').classList.add('hidden');
        document.getElementById('personal-table-version').classList.remove('hidden');
    }
    
    // Agregar una persona inicial
    addPersonal();
});

        // --- Lógica para etapas de trabajo ---
        let etapaCount = 0;
        function addEtapaRow() {
            etapaCount++;
            const etapaDiv = document.createElement('div');
            etapaDiv.style.marginBottom = '2rem';
            etapaDiv.style.padding = '1.5rem';
            etapaDiv.style.border = '1px solid var(--neutral-200)';
            etapaDiv.style.borderRadius = '12px';
            etapaDiv.style.background = 'white';
            etapaDiv.style.boxShadow = 'var(--shadow-md)';
            etapaDiv.style.position = 'relative';
            etapaDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h4 style="font-size: 1.125rem; font-weight: 600; color: var(--primary-color); margin: 0;">Etapa ${etapaCount}</h4>
                    <button type="button" class="btn btn-danger remove-etapa-btn" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">&times;</button>
                </div>
                <div style="display: grid; gap: 1.5rem;">
                    <div>
                        <label class="form-label required-field">Descripción de la Etapa</label>
                        <textarea name="etapa_descripcion_${etapaCount}" class="form-textarea" placeholder="Describa detalladamente esta etapa del trabajo..." required></textarea>
                    </div>
                    <div>
                        <label class="form-label">Riesgos Potenciales (Seleccione todos los que apliquen)</label>
                        <div class="checkbox-group" style="max-height: 200px;">
                            ${riesgosPotenciales.map((riesgo, index) => `
                                <div class="checkbox-item">
                                    <input type="checkbox" id="riesgo_${etapaCount}_${index}" name="etapa_riesgos_${etapaCount}" value="${riesgo}">
                                    <label for="riesgo_${etapaCount}_${index}">${riesgo}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div>
                        <label class="form-label required-field">Medidas de Control</label>
                        <textarea name="etapa_medidas_${etapaCount}" class="form-textarea" placeholder="Describa las medidas de control para mitigar los riesgos identificados..." required></textarea>
                    </div>
                </div>
            `;
            document.getElementById('etapas-container').appendChild(etapaDiv);
        }

        document.getElementById('etapas-container').addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-etapa-btn')) {
                e.target.closest('div').remove();
            }
        });

        document.getElementById('add-etapa-button').addEventListener('click', addEtapaRow);

        // --- Inicialización ---
        document.addEventListener('DOMContentLoaded', function() {
            setCurrentDateTime();
            setupSignaturePad('signature-supervisor');
            setupSignaturePad('signature-apr');
            addPersonalRow(); // Agregar una fila inicial de personal
            addEtapaRow(); // Agregar una etapa inicial
        });

        // --- Envío del formulario ---
        document.getElementById('astForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Agregar clase de loading al botón
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Enviando...';
            submitBtn.disabled = true;
            
            // Simular envío
            setTimeout(() => {
                alert('Formulario AST enviado correctamente!');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                // Aquí iría la lógica de envío real
            }, 2000);
        });

        // --- Responsive para botones en mobile ---
        function adjustButtonsForMobile() {
            const isMobile = window.innerWidth < 768;
            const buttonContainer = document.querySelector('.form-section:last-child > div:last-child > div');
            
            if (isMobile) {
                buttonContainer.style.flexDirection = 'column';
            } else {
                buttonContainer.style.flexDirection = 'row';
                buttonContainer.style.justifyContent = 'flex-end';
            }
        }

        window.addEventListener('resize', adjustButtonsForMobile);
        window.addEventListener('load', adjustButtonsForMobile);
    </script>
</body>
</html>
